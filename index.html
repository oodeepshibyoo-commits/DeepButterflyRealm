<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>DeepButterfly Realm üíúüëë</title>
<style>
body{
    margin:0;
    background:#0a0a0f;
    color:#fff;
    font-family:Arial,Helvetica,sans-serif;
    display:grid;
    grid-template-columns:260px 1fr;
    grid-template-rows:auto 220px 1fr auto;
    grid-template-areas:
        "side head"
        "side room"
        "side chat"
        "side input";
    height:100vh;
    overflow:hidden;
    position:relative;
}
/* Pinke Neon-Uhr oben rechts */
#clockTop{
    position:fixed;
    right:20px;
    top:10px;
    z-index:9999;
    color:#ff4dfd;
    font-size:.7rem;
    font-weight:600;
    text-shadow:0 0 8px #ff4dfd,0 0 12px #00fff6;
    font-family:Consolas,Menlo,monospace;
}

/* HEADER */
header{
    grid-area:head;
    background:#1a1a24cc;
    border-bottom:2px solid #6b00ff;
    box-shadow:0 20px 60px rgba(255,77,253,.25),
               0 0 40px rgba(0,255,246,.25),
               0 0 120px rgba(107,0,255,.4);
    padding:.75rem 1rem;
    font-size:.8rem;
    line-height:1.4;
    text-align:center;
    z-index:10;
}
header .big{
    color:#ff4dfd;
    font-weight:600;
    text-shadow:0 0 10px #ff4dfd,0 0 20px #00fff6;
}
header .sub{
    color:#00fff6;
    font-size:.7rem;
    text-shadow:0 0 6px #00fff6;
}

/* SIDEBAR */
aside{
    grid-area:side;
    background:#1a1a24dd;
    border-right:2px solid #6b00ff;
    box-shadow:0 0 30px rgba(255,77,253,.3),
               0 0 80px rgba(0,255,246,.2);
    padding:.75rem;
    font-size:.75rem;
    overflow-y:auto;
    z-index:10;
}
h2{
    margin:.5rem 0 .25rem;
    font-size:.75rem;
    font-weight:600;
    color:#ff4dfd;
    text-shadow:0 0 6px #ff4dfd,0 0 10px #00fff6;
}
small{
    color:#8a8a9f;
    font-size:.7rem;
    line-height:1.4;
    display:block;
    margin-bottom:.5rem;
}
.block{
    border:2px solid #6b00ff;
    border-radius:10px;
    background:#2a2a38aa;
    box-shadow:0 0 16px rgba(107,0,255,.4),
               0 0 32px rgba(0,255,246,.2);
    padding:.5rem .75rem;
    margin-bottom:1rem;
    font-size:.7rem;
    line-height:1.4;
}

label{
    display:block;
    font-size:.7rem;
    font-weight:600;
    color:#fff;
    text-shadow:0 0 6px #fff,0 0 10px #00fff6;
    margin-bottom:.25rem;
}
input[type="text"],
input[type="password"],
input[type="color"],
select{
    width:100%;
    background:#2a2a38;
    color:#fff;
    border:2px solid #6b00ff;
    border-radius:8px;
    font-size:.7rem;
    padding:.4rem .5rem;
    margin-bottom:.5rem;
    box-shadow:0 0 12px rgba(107,0,255,.6),
               0 0 24px rgba(0,255,246,.4);
    outline:none;
}
button.btn{
    width:100%;
    background:radial-gradient(circle at 20% 20%, #ff4dfd 0%, #6b00ff 60%);
    border:0;
    border-radius:8px;
    color:#000;
    font-size:.75rem;
    font-weight:700;
    line-height:1.2;
    padding:.5rem .6rem;
    cursor:pointer;
    text-shadow:0 0 6px #fff,0 0 12px #00fff6;
    box-shadow:0 12px 30px rgba(255,77,253,.45),
               0 0 20px rgba(0,255,246,.4),
               0 0 60px rgba(107,0,255,.6);
    margin-bottom:.5rem;
}
button.btn:disabled{
    opacity:.4;
    cursor:not-allowed;
}
.statusLine{
    color:#8a8a9f;
    font-size:.7rem;
    line-height:1.4;
    min-height:2.8em;
    white-space:pre-wrap;
}

/* ONLINE LISTE */
#onlineList .userRow{
    border:2px solid #6b00ff;
    border-radius:8px;
    background:#2a2a38aa;
    box-shadow:0 0 12px rgba(107,0,255,.4),
               0 0 24px rgba(0,255,246,.2);
    padding:.5rem;
    margin-bottom:.5rem;
    line-height:1.3;
    cursor:pointer;
}
.nameLine{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:.4rem;
    font-weight:600;
}
.avatarEmoji{
    font-size:1rem;
    line-height:1rem;
    animation:bounce 2s ease-in-out infinite;
    text-shadow:0 0 8px #fff,0 0 12px #ff4dfd;
}
@keyframes bounce{
    0%   {transform:translateY(0) rotate(-2deg) scale(1);}
    25%  {transform:translateY(-2px) rotate(2deg) scale(1.05);}
    50%  {transform:translateY(0) rotate(-1deg) scale(1);}
    75%  {transform:translateY(-3px) rotate(3deg) scale(1.07);}
    100% {transform:translateY(0) rotate(-2deg) scale(1);}
}
.roleCrown{
    color:#ffd93b;
    text-shadow:0 0 6px #ffd93b,0 0 12px #ff4dfd;
    font-size:.8rem;
}
.metaLine{
    color:#aaa;
    font-size:.65rem;
}

/* RAUM OBEN */
#roomWrap{
    grid-area:room;
    background:#1a1a24dd;
    border-bottom:2px solid #6b00ff;
    box-shadow:0 0 30px rgba(255,77,253,.3),
               0 0 80px rgba(0,255,246,.2);
    position:relative;
    overflow:hidden;
    padding:.5rem .75rem .75rem;
    font-size:.7rem;
}
#roomTitle{
    color:#ff4dfd;
    font-weight:600;
    font-size:.75rem;
    text-shadow:0 0 10px #ff4dfd,0 0 20px #00fff6;
    margin-bottom:.5rem;
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
}
#roomArea{
    position:relative;
    width:100%;
    height:160px;
    border:2px solid #6b00ff;
    border-radius:10px;
    background:radial-gradient(circle at 20% 20%,rgba(107,0,255,.4)0%,rgba(0,0,0,.2)60%);
    box-shadow:0 0 20px rgba(107,0,255,.6),
               0 0 60px rgba(0,255,246,.2),
               0 0 120px rgba(255,77,253,.2);
    overflow:hidden;
}
.roomAvatar{
    position:absolute;
    cursor:grab;
    user-select:none;
    font-size:1.4rem;
    line-height:1.4rem;
    text-shadow:0 0 8px #fff,0 0 12px #ff4dfd;
    display:flex;
    flex-direction:column;
    align-items:center;
    font-weight:600;
    min-width:2rem;
    text-align:center;
}
.roomName{
    font-size:.6rem;
    margin-top:.25rem;
    text-shadow:0 0 6px #00fff6;
}
.roomCrown{
    color:#ffd93b;
    text-shadow:0 0 6px #ffd93b,0 0 12px #ff4dfd;
    font-size:.6rem;
    margin-left:.25rem;
}

/* CHAT FENSTER */
main{
    grid-area:chat;
    background:#1a1a24dd;
    box-shadow:0 0 30px rgba(255,77,253,.3),
               0 0 80px rgba(0,255,246,.2);
    display:flex;
    flex-direction:column;
    position:relative;
    overflow:hidden;
}
#messages{
    flex:1;
    overflow-y:auto;
    padding:1rem;
    font-family:Consolas,Menlo,monospace;
    font-size:.8rem;
    line-height:1.4;
}
.msgBubble{
    border:2px solid #6b00ff;
    background:#2a2a38;
    box-shadow:0 0 20px rgba(107,0,255,.4),
               0 0 40px rgba(0,255,246,.2);
    border-radius:10px;
    padding:.6rem .7rem;
    margin-bottom:.6rem;
    max-width:85%;
    white-space:pre-wrap;
    word-break:break-word;
}
.msgBubble.system{
    border-color:#444;
    background:#2a2a3844;
    box-shadow:none;
}
.msgHeader{
    font-weight:600;
    font-size:.7rem;
    margin-bottom:.4rem;
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:.4rem;
}
.msgHeaderName{
    text-shadow:0 0 8px #fff,0 0 12px #00fff6;
}
.msgHeaderName.systemName{
    color:#888 !important;
    text-shadow:none;
}
.msgHeaderRole{
    color:#ffd93b;
    text-shadow:0 0 6px #ffd93b,0 0 12px #ff4dfd;
    font-size:.7rem;
}
.msgOriginal{
    color:#bbb;
    margin-bottom:.4rem;
}
.msgInfoLine{
    font-size:.65rem;
    color:#ff4dfd;
    text-shadow:0 0 8px #ff4dfd,0 0 12px #00fff6;
    margin-bottom:.25rem;
    display:flex;
    flex-wrap:wrap;
    gap:.5rem;
}
.msgTranslation{
    color:#fff;
    text-shadow:0 0 6px #fff,0 0 12px #00fff6;
    white-space:pre-wrap;
    word-break:break-word;
}
.msgTime{
    font-size:.6rem;
    font-family:Consolas,Menlo,monospace;
    color:#ff4dfd;
    text-shadow:0 0 8px #ff4dfd,0 0 12px #00fff6;
    margin-top:.4rem;
    text-align:right;
}

/* UNTEN: Nachricht schreiben */
footer{
    grid-area:input;
    background:#1a1a24cc;
    border-top:2px solid #6b00ff;
    box-shadow:0 -20px 60px rgba(255,77,253,.25),
               0 0 40px rgba(0,255,246,.25),
               0 0 120px rgba(107,0,255,.4);
    padding:.75rem;
    display:grid;
    grid-template-columns:1fr auto;
    gap:.5rem;
    align-items:flex-start;
}
#msgInput{
    width:100%;
    height:60px;
    resize:none;
    background:#2a2a38;
    color:#fff;
    border:2px solid #6b00ff;
    border-radius:8px;
    font-size:.8rem;
    line-height:1.3;
    font-family:Consolas,Menlo,monospace;
    padding:.6rem .7rem;
    box-shadow:inset 0 0 12px rgba(0,0,0,.6),
               0 0 20px rgba(107,0,255,.5);
    outline:none;
}
#sendBtn{
    background:radial-gradient(circle at 20% 20%, #00fff6 0%, #003d3d 60%);
    border:0;
    border-radius:10px;
    color:#00fff6;
    text-shadow:0 0 8px #00fff6,0 0 12px #ff4dfd;
    font-size:.8rem;
    font-weight:700;
    line-height:1.2;
    padding:.6rem .8rem;
    cursor:pointer;
    box-shadow:0 12px 30px rgba(0,255,246,.4),
               0 0 20px rgba(255,77,253,.4),
               0 0 60px rgba(107,0,255,.6);
    min-width:120px;
}
#sendBtn:disabled{
    opacity:.4;
    cursor:not-allowed;
}

/* Hilfe-Box unter Registrierung */
#helpBox{
    border:1px solid #6b00ff;
    border-radius:8px;
    background:#1a1a24;
    box-shadow:0 0 16px rgba(107,0,255,.4),
               0 0 32px rgba(0,255,246,.2);
    padding:.5rem .6rem;
    font-size:.7rem;
    line-height:1.4;
    color:#fff;
    white-space:pre-wrap;
}
#helpBoxTitle{
    font-weight:600;
    color:#ff4dfd;
    text-shadow:0 0 8px #ff4dfd,0 0 12px #00fff6;
    margin-bottom:.4rem;
    font-size:.7rem;
}
</style>
</head>
<body>

<div id="clockTop">--:--</div>

<header>
    <div class="big">DeepButterfly Realm üíúüëë</div>
    <div class="sub">Multilingual ¬∑ Owner-Krone ¬∑ Farben ¬∑ Avatare ¬∑ Raum ü¶ã ¬∑ Moderation</div>
</header>

<aside id="asideBox">
    <div class="block">
        <h2>Login</h2>
        <label for="loginUser">Benutzername</label>
        <input id="loginUser" type="text" placeholder="z.B. DeepButterflyMusic" />
        <label for="loginPass">Passwort</label>
        <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <button class="btn" id="loginBtn">Einloggen</button>
        <div class="statusLine" id="loginStatus"></div>
    </div>

    <div class="block">
        <h2>Registrieren</h2>

        <label for="helpLangSelect">Hilfe-Sprache / Seg√≠ts√©g nyelve</label>
        <select id="helpLangSelect">
            <option value="de">Deutsch</option>
            <option value="hu">Magyar (Ungarisch)</option>
        </select>

        <div id="helpBox">
            <div id="helpBoxTitle">So meldest du dich an üíú</div>
            <div id="helpBoxText">
1. W√§hle einen Namen.
2. W√§hle ein Passwort.
3. W√§hle dein Avatar-Emoji (ü¶ã z.B.).
4. W√§hle deine Farbe.
5. Sprache: Das ist, wie du Nachrichten lesen wirst.
6. Klick "Account erstellen".
Dann geh zu Login und melde dich damit an.
            </div>
        </div>

        <br/>

        <label for="regUser">Neuer Name</label>
        <input id="regUser" type="text" placeholder="z.B. DarkInfernal" />
        <label for="regPass">Passwort</label>
        <input id="regPass" type="password" placeholder="Passwort w√§hlen" />

        <label for="regAvatar">Avatar Emoji / Symbol</label>
        <input id="regAvatar" type="text" value="ü¶ã" />

        <label for="regColor">Name Farbe</label>
        <input id="regColor" type="color" value="#ff4dfd" />

        <label for="regLang">Sprache f√ºr √úbersetzung</label>
        <select id="regLang"></select>

        <label for="regTheme">Dein Style / Theme / Schrift</label>
        <input id="regTheme" type="text" placeholder="butterfly / fire / rose / neon ..." />

        <button class="btn" id="regBtn">Account erstellen</button>

        <div class="statusLine" id="regStatus"></div>
    </div>

    <div class="block">
        <h2>Dein Profil</h2>
        <small>Dein Avatar / Farbe / Sprache / Style kannst du selber √§ndern üíÖ</small>

        <label for="profAvatar">Avatar Emoji</label>
        <input id="profAvatar" type="text" />

        <label for="profColor">Name Farbe</label>
        <input id="profColor" type="color" value="#ffffff"/>

        <label for="profLang">Deine Sprache</label>
        <select id="profLang"></select>

        <label for="profTheme">Theme / Schrift</label>
        <input id="profTheme" type="text" placeholder="butterfly / fire / etc."/>

        <button class="btn" id="saveProfileBtn">Speichern</button>

        <div class="statusLine" id="profileStatus"></div>
    </div>

    <div class="block" id="moderationBlock">
        <h2>Wer ist online?</h2>
        <small>Tippe auf einen Namen, wenn du Owner/Admin bist ‚Üí Admin machen / Kicken / Bannen</small>
        <div id="onlineList"></div>
    </div>
</aside>

<div id="roomWrap">
    <div id="roomTitle">
        <span>Butterfly Room ü¶ã Alle Avatare in Echtzeit ‚Äì du kannst dich hinsetzen</span>
        <span style="color:#8a8a9f;font-size:.65rem;line-height:1.2;">
            Zieh dich wohin du willst üíñ
        </span>
    </div>
    <div id="roomArea"></div>
</div>

<main>
    <div id="messages"></div>
</main>

<footer>
    <div style="display:flex;flex-direction:column;gap:.4rem;">
        <textarea id="msgInput" placeholder="Schreib hier... (Enter = senden, Shift+Enter = neue Zeile)" disabled></textarea>
        <div id="clockBottom" style="color:#ff4dfd;font-size:.65rem;font-family:Consolas,Menlo,monospace;text-shadow:0 0 8px #ff4dfd,0 0 12px #00fff6; text-align:right;">--:--:--</div>
    </div>
    <button id="sendBtn" disabled>Senden</button>
</footer>

<script src="/socket.io/socket.io.js"></script>
<script>
// ===== Spracheinstellungen =====
const LANGS = [
    {code:"de", name:"Deutsch"},
    {code:"hu", name:"Magyar / Ungarisch"},
    {code:"en", name:"English"},
    {code:"es", name:"Espa√±ol"},
    {code:"fr", name:"Fran√ßais"},
    {code:"it", name:"Italiano"},
    {code:"pt", name:"Portugu√™s"},
    {code:"tr", name:"T√ºrk√ße"},
    {code:"ru", name:"–†—É—Å—Å–∫–∏–π"},
    {code:"ar", name:"ÿßŸÑÿπÿ±ÿ®Ÿäÿ©"},
    {code:"zh", name:"‰∏≠Êñá"},
    {code:"ja", name:"Êó•Êú¨Ë™û"}
];

// ===== Hilfe-Texte (Deutsch/Ungarisch) =====
const HELP_TEXT = {
    de:{
        title:"So meldest du dich an üíú",
        body:
`1. W√§hle einen Namen.
2. W√§hle ein Passwort.
3. W√§hle dein Avatar-Emoji (ü¶ã z.B.).
4. W√§hle deine Farbe.
5. Sprache: So liest du Nachrichten.
6. Klick "Account erstellen".
Dann geh zu Login und melde dich damit an.

Der ERSTE Account wird Owner üëë.
Owner/Admin k√∂nnen kicken oder bannen.`
    },
    hu:{
        title:"√çgy tudsz bel√©pni üíú",
        body:
`1. V√°lassz nevet.
2. V√°lassz jelsz√≥t.
3. V√°lassz avatar emojit (pl. ü¶ã).
4. V√°lassz n√©vsz√≠nt.
5. Nyelv: ezen a nyelven olvasod az √ºzeneteket.
6. Kattints: "Fi√≥k l√©trehoz√°sa".

Az ELS≈ê felhaszn√°l√≥ lesz az Owner üëë.
Owner / Admin ki tud r√∫gni vagy tiltani m√°sokat.`
    }
};

// ===== GOOGLE TRANSLATE API =====
// WICHTIG: Hier deinen echten Google Translate API Key eintragen!
const GOOGLE_API_KEY = "DEIN_KEY_HIER";

// ruft Google Translate an
async function translateAuto(text,targetLang){
    try{
        const res = await fetch(
            "https://translation.googleapis.com/language/translate/v2?key="+GOOGLE_API_KEY,
            {
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({
                    q:text,
                    target:targetLang
                })
            }
        );
        const data = await res.json();
        if(data?.data?.translations?.[0]){
            const tObj = data.data.translations[0];
            return {
                translatedText: tObj.translatedText || text,
                detectedSource: tObj.detectedSourceLanguage || "auto"
            };
        } else {
            return {
                translatedText: text,
                detectedSource: "auto"
            };
        }
    }catch(err){
        console.error("√úbersetzungsfehler:",err);
        return {
            translatedText: text + " (kein √úbersetzer üò¢)",
            detectedSource: "auto"
        };
    }
}

// ===== DOM Refs =====
const asideEl        = document.getElementById("asideBox");
const moderationWrap = document.getElementById("moderationBlock");

const loginUser   = document.getElementById("loginUser");
the_loginPass = document.getElementById("loginPass"); // renamed variable after copy?
</script>
</body>
</html>
<script>
// ====== STATE ======
let authToken = null;
let myProfile = null;
let dragging = null;
let currentRoomState = {};
let socket;

// Sprache in Dropdowns laden
function fillLangSelect(sel){
  LANGS.forEach(l=>{
    const opt=document.createElement("option");
    opt.value=l.code;
    opt.textContent=l.name;
    sel.appendChild(opt);
  });
}
fillLangSelect(document.getElementById("regLang"));
fillLangSelect(document.getElementById("profLang"));

// ====== Uhrzeit oben & unten ======
function updateClock(){
  const now=new Date();
  const t=now.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
  document.getElementById("clockTop").textContent=t;
  document.getElementById("clockBottom").textContent=t;
}
setInterval(updateClock,1000);
updateClock();

// ====== √úbersetzungshilfe f√ºr Registrierung ======
const helpLangSelect=document.getElementById("helpLangSelect");
const helpBoxTitle=document.getElementById("helpBoxTitle");
const helpBoxText=document.getElementById("helpBoxText");
helpLangSelect.addEventListener("change",()=>{
  const l=HELP_TEXT[helpLangSelect.value]||HELP_TEXT.de;
  helpBoxTitle.textContent=l.title;
  helpBoxText.textContent=l.body;
});

// ====== UI Helfer ======
function setStatus(el,msg,err=false){
  el.textContent=msg;
  el.style.color=err?"#ff4dfd":"#8a8a9f";
}

// ====== SOCKET.IO ======
function setupSocket(){
  socket=io();

  socket.on("chatMessage",async msg=>{
    await addMessage(msg);
  });
  socket.on("userlist",arr=>{
    if(!authToken){
      document.getElementById("onlineList").innerHTML="<i>(Bitte einloggen)</i>";
      asideEl.style.filter="blur(2px)";
      return;
    }
    asideEl.style.filter="none";
    renderOnlineList(arr);
  });
  socket.on("roomUpdate",s=>{
    currentRoomState=s.avatars||{};
    renderRoom();
  });
  socket.on("forceLogout",d=>{
    alert(d?.reason||"Verbindung getrennt");
    authToken=null;myProfile=null;
    document.getElementById("msgInput").disabled=true;
    document.getElementById("sendBtn").disabled=true;
  });
}
setupSocket();

// ====== CHAT ANZEIGE ======
async function addMessage(msg){
  const isSystem=(msg.from==="System");
  const wrap=document.createElement("div");
  wrap.className="msgBubble"+(isSystem?" system":"");

  const head=document.createElement("div");
  head.className="msgHeader";
  head.innerHTML=`<span class='avatarEmoji'>${msg.avatar||"üí¨"}</span>
                  <span class='msgHeaderName' style='color:${msg.color||"#fff"}'>${msg.from}</span>
                  ${(msg.role==="owner"||msg.role==="admin")?"<span class='msgHeaderRole'>üëë</span>":""}`;
  wrap.appendChild(head);

  const info=document.createElement("div");
  info.className="msgInfoLine";
  info.textContent=isSystem?"Systemnachricht":"√úbersetze...";
  wrap.appendChild(info);

  const orig=document.createElement("div");
  orig.className="msgOriginal";
  orig.textContent=msg.text;
  wrap.appendChild(orig);

  if(!isSystem && myProfile){
    const t=await translateAuto(msg.text,myProfile.language||"de");
    info.textContent="Sprache erkannt: "+t.detectedSource+" ‚Üí "+(myProfile.language||"de");
    const tr=document.createElement("div");
    tr.className="msgTranslation";
    tr.innerHTML=t.translatedText;
    wrap.appendChild(tr);
  }

  const time=document.createElement("div");
  time.className="msgTime";
  time.textContent=new Date(msg.timestamp||Date.now()).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
  wrap.appendChild(time);

  document.getElementById("messages").appendChild(wrap);
  document.getElementById("messages").scrollTop=999999;
}

// ====== ONLINE-LISTE ======
function renderOnlineList(arr){
  const box=document.getElementById("onlineList");
  box.innerHTML="";
  arr.forEach(u=>{
    const row=document.createElement("div");
    row.className="userRow";
    row.innerHTML=`<div class='nameLine'><span class='avatarEmoji'>${u.avatar}</span>
                   <span style='color:${u.color};font-weight:600;'>${u.username}</span>
                   ${(u.role==="owner"||u.role==="admin")?"<span class='roleCrown'>üëë</span>":""}</div>
                   <div class='metaLine'>${u.language}</div>`;
    row.onclick=()=>{
      if(!myProfile)return;
      if(!(myProfile.role==="owner"||myProfile.role==="admin"))return;
      if(u.username===myProfile.username)return;
      const c=prompt(`Aktion f√ºr ${u.username}?\n1=Mitbesitzer machen\n2=Kicken\n3=Bannen`);
      if(c==="1")socket.emit("promoteCoOwner",{token:authToken,targetUser:u.username});
      if(c==="2")socket.emit("kickUser",{token:authToken,targetUser:u.username});
      if(c==="3")socket.emit("banUser",{token:authToken,targetUser:u.username});
    };
    box.appendChild(row);
  });
}

// ====== RAUM ======
function renderRoom(){
  const area=document.getElementById("roomArea");
  area.innerHTML="";
  for(const name in currentRoomState){
    const p=currentRoomState[name];
    const el=document.createElement("div");
    el.className="roomAvatar";
    el.style.left=p.x+"px";
    el.style.top=p.y+"px";
    el.innerHTML=`<div>${p.avatar}</div>
                  <div class='roomName' style='color:${p.color}'>${name}${(p.role==="owner"||p.role==="admin")?"<span class='roomCrown'>üëë</span>":""}</div>`;
    if(myProfile && name===myProfile.username){
      el.onmousedown=e=>{dragging={el,x:e.offsetX,y:e.offsetY}};
    }
    area.appendChild(el);
  }
}
window.onmousemove=e=>{
  if(!dragging||!myProfile)return;
  const area=document.getElementById("roomArea");
  const rect=area.getBoundingClientRect();
  const x=e.clientX-rect.left-dragging.x;
  const y=e.clientY-rect.top-dragging.y;
  dragging.el.style.left=x+"px";
  dragging.el.style.top=y+"px";
  socket.emit("moveAvatar",{token:authToken,x,y});
};
window.onmouseup=()=>dragging=null;

// ====== LOGIN & REGISTER ======
async function doLogin(){
  const u=loginUser.value.trim();
  const p=loginPass.value.trim();
  setStatus(document.getElementById("loginStatus"),"Login...");
  const res=await fetch("/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u,password:p})});
  const data=await res.json();
  if(!data.ok)return setStatus(document.getElementById("loginStatus"),data.error,true);
  authToken=data.token;myProfile=data.profile;
  setStatus(document.getElementById("loginStatus"),`Eingeloggt als ${myProfile.username} (${myProfile.role})`);
  document.getElementById("msgInput").disabled=false;
  document.getElementById("sendBtn").disabled=false;
  socket.emit("joinChat",authToken);
}
document.getElementById("loginBtn").onclick=doLogin;

document.getElementById("regBtn").onclick=async()=>{
  const b={username:regUser.value.trim(),password:regPass.value.trim(),avatar:regAvatar.value,color:regColor.value,language:regLang.value,theme:regTheme.value};
  setStatus(regStatus,"Erstelle Account...");
  const res=await fetch("/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)});
  const d=await res.json();
  if(!d.ok)setStatus(regStatus,d.error,true);else setStatus(regStatus,"Account erstellt üíú Jetzt einloggen");
};

// ====== PROFIL SPEICHERN ======
document.getElementById("saveProfileBtn").onclick=async()=>{
  if(!authToken)return setStatus(profileStatus,"Nicht eingeloggt",true);
  const b={token:authToken,avatar:profAvatar.value,color:profColor.value,language:profLang.value,theme:profTheme.value};
  const res=await fetch("/profile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)});
  const d=await res.json();
  if(!d.ok)setStatus(profileStatus,d.error,true);
  else{myProfile=d.profile;setStatus(profileStatus,"Gespeichert üíú");}
};

// ====== SENDEN ======
document.getElementById("sendBtn").onclick=()=>{
  const t=document.getElementById("msgInput").value.trim();
  if(!t)return;
  socket.emit("sendMessage",{token:authToken,text:t});
  document.getElementById("msgInput").value="";
};
document.getElementById("msgInput").onkeydown=e=>{
  if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();document.getElementById("sendBtn").click();}
};
</script>


