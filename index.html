<script src="/socket.io/socket.io.js"></script>
<script>
/* ======== 🌍 Sprachen & Grunddaten ======== */
const LANGS = [
  { code: "de", name: "Deutsch" },
  { code: "hu", name: "Magyar / Ungarisch" },
  { code: "en", name: "English" },
  { code: "es", name: "Español" },
  { code: "fr", name: "Français" },
  { code: "it", name: "Italiano" },
  { code: "pt", name: "Português" },
  { code: "tr", name: "Türkçe" },
  { code: "ru", name: "Русский" },
  { code: "ar", name: "العربية" },
  { code: "zh", name: "中文" },
  { code: "ja", name: "日本語" }
];

const SERVERS = ["/translateText"]; // nutzt deinen Server als Proxy

/* ======== 📦 DOM Referenzen ======== */
const loginUser = document.getElementById("loginUser");
const loginPass = document.getElementById("loginPass");
const loginBtn  = document.getElementById("loginBtn");
const loginStatus = document.getElementById("loginStatus");
const regUser = document.getElementById("regUser");
const regPass = document.getElementById("regPass");
const regAvatar = document.getElementById("regAvatar");
const regColor = document.getElementById("regColor");
const regLang  = document.getElementById("regLang");
const regTheme = document.getElementById("regTheme");
const regBtn   = document.getElementById("regBtn");
const regStatus= document.getElementById("regStatus");
const profAvatar = document.getElementById("profAvatar");
const profColor  = document.getElementById("profColor");
const profLang   = document.getElementById("profLang");
const profTheme  = document.getElementById("profTheme");
const saveProfileBtn = document.getElementById("saveProfileBtn");
const profileStatus  = document.getElementById("profileStatus");
const onlineList = document.getElementById("onlineList");
const messagesEl = document.getElementById("messages");
const msgInput   = document.getElementById("msgInput");
const sendBtn    = document.getElementById("sendBtn");
const roomArea   = document.getElementById("roomArea");

/* ======== 🔤 Sprachauswahl füllen ======== */
function fillLangSelect(sel){
  LANGS.forEach(l=>{
    const o=document.createElement("option");
    o.value=l.code;
    o.textContent=l.name;
    sel.appendChild(o);
  });
}
fillLangSelect(regLang);
fillLangSelect(profLang);

/* ======== 💬 Übersetzungsfunktion ======== */
async function translateTextSmart(rawText, targetLang){
  const key = "cache|" + targetLang + "|" + rawText;
  const cache = sessionStorage.getItem(key);
  if(cache) return cache;

  try {
    const res = await fetch("/translateText", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ text: rawText, target: targetLang })
    });
    const data = await res.json();
    if(!data.ok) throw new Error("Fehler");
    sessionStorage.setItem(key, data.translatedText);
    return data.translatedText;
  } catch(e) {
    console.warn("Übersetzung fehlgeschlagen:", e);
    return rawText + " (Übersetzung nicht verfügbar 😢)";
  }
}

/* ======== 🔐 Login / Registrierung ======== */
let authToken = null;
let myProfile = null;
let dragging = null;
let currentRoomState = {};

function setStatus(el, msg, isErr=false){
  el.textContent = msg;
  el.style.color = isErr ? "#ff4dfd" : "#8a8a9f";
}

/* ======== 🪶 CHAT Nachrichten anzeigen ======== */
async function addMessageBubble(msg){
  const isSystem = (msg.from==="System");
  const wrap = document.createElement("div");
  wrap.className="msgBubble"+(isSystem?" system":"");

  const head=document.createElement("div");
  head.className="msgHeader";

  const avSpan=document.createElement("span");
  avSpan.className="avatarEmoji";
  avSpan.textContent=msg.avatar || "💬";

  const nameSpan=document.createElement("span");
  nameSpan.className="msgHeaderName";
  nameSpan.textContent=msg.from;
  if(isSystem){
    nameSpan.style.color="#888";
  } else if(msg.color){
    nameSpan.style.color=msg.color;
    nameSpan.style.textShadow=`0 0 6px ${msg.color},0 0 12px #00fff6`;
  }

  head.appendChild(avSpan);
  head.appendChild(nameSpan);
  if(msg.role==="owner"||msg.role==="admin"){
    const cr=document.createElement("span");
    cr.className="msgHeaderRole";
    cr.textContent="👑";
    head.appendChild(cr);
  }

  wrap.appendChild(head);

  const orig=document.createElement("div");
  orig.className="msgOriginal";
  orig.textContent=msg.text;
  wrap.appendChild(orig);

  if(!isSystem && myProfile){
    const arr=document.createElement("div");
    arr.className="msgArrow";
    arr.textContent="→ übersetzt für dich:";
    wrap.appendChild(arr);

    const trans=document.createElement("div");
    trans.className="msgTranslation";
    trans.textContent="(übersetze ...)";
    wrap.appendChild(trans);

    const t = await translateTextSmart(msg.text, myProfile.language || "de");
    trans.textContent=t;
  }

  messagesEl.appendChild(wrap);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* ======== ⚡ Socket.IO ======== */
const socket = io();

socket.on("chatMessage",(msg)=> addMessageBubble(msg));
socket.on("userlist",(arr)=> renderOnlineList(arr));
socket.on("roomUpdate",(s)=>{ currentRoomState=s; renderRoom(); });
socket.on("forceLogout",(data)=>{
  alert(data?.reason || "Du wurdest getrennt.");
  authToken=null; myProfile=null;
  msgInput.disabled=true; sendBtn.disabled=true;
});

/* ======== 👑 Online-Liste ======== */
function renderOnlineList(arr){
  onlineList.innerHTML="";
  arr.forEach(u=>{
    const row=document.createElement("div");
    row.className="userRow";
    row.innerHTML = `
      <div class="nameLine">
        <span class="avatarEmoji">${u.avatar||"⭐"}</span>
        <span style="color:${u.color||"#fff"};font-weight:600;text-shadow:0 0 6px ${u.color||"#fff"},0 0 10px #ff4dfd;">
          ${u.username}
        </span>
        ${u.role==="owner"||u.role==="admin" ? "<span class='roleCrown'>👑</span>" : ""}
      </div>
      <div class="metaLine">Online · Sprache: ${u.language||"?"}</div>
    `;
    row.addEventListener("click",()=>{
      if(!myProfile) return;
      const iAmMod=(myProfile.role==="owner"||myProfile.role==="admin");
      if(!iAmMod || myProfile.username===u.username) return;

      const choice = prompt(
        "Aktion für "+u.username+"?\n"+
        "1 = Admin machen\n"+
        "2 = Kicken\n"+
        "3 = Bannen\n"+
        "Andere Taste = Abbrechen"
      );
      if(choice==="1"){
        socket.emit("promoteAdmin",{token:authToken,targetUser:u.username});
      } else if(choice==="2"){
        socket.emit("kickUser",{token:authToken,targetUser:u.username});
      } else if(choice==="3"){
        socket.emit("banUser",{token:authToken,targetUser:u.username});
      }
    });
    onlineList.appendChild(row);
  });
}

/* ======== 🎭 Raum rendern ======== */
function renderRoom(){
  roomArea.innerHTML="";
  for(const u in currentRoomState){
    const info=currentRoomState[u];
    const box=document.createElement("div");
    box.className="roomAvatar";
    box.style.left=(info.x||20)+"px";
    box.style.top=(info.y||20)+"px";
    box.innerHTML=`
      <div style="text-shadow:0 0 8px ${info.color||"#fff"},0 0 12px #ff4dfd;">${info.avatar||"⭐"}</div>
      <div class="roomName" style="color:${info.color||"#fff"};">
        ${u}${info.role==="owner"||info.role==="admin"?"<span class='roomCrown'>👑</span>":""}
      </div>`;
    if(myProfile && u===myProfile.username){
      box.addEventListener("mousedown",(ev)=>{
        dragging={username:u,el:box,offsetX:ev.offsetX,offsetY:ev.offsetY};
      });
      box.addEventListener("touchstart",(ev)=>{
        const t=ev.touches[0];
        const rect=box.getBoundingClientRect();
        dragging={username:u,el:box,offsetX:t.clientX-rect.left,offsetY:t.clientY-rect.top};
      },{passive:false});
    }
    roomArea.appendChild(box);
  }
}
window.addEventListener("mousemove",e=>movePointer(e.clientX,e.clientY));
window.addEventListener("mouseup",()=>dragging=null);
window.addEventListener("touchmove",e=>{
  if(e.touches[0]) movePointer(e.touches[0].clientX,e.touches[0].clientY);
},{passive:false});
window.addEventListener("touchend",()=>dragging=null);

function movePointer(x,y){
  if(!dragging||!myProfile||dragging.username!==myProfile.username)return;
  const b=roomArea.getBoundingClientRect();
  let nx=x-b.left-dragging.offsetX, ny=y-b.top-dragging.offsetY;
  nx=Math.max(0,Math.min(b.width-40,nx));
  ny=Math.max(0,Math.min(b.height-40,ny));
  dragging.el.style.left=nx+"px";
  dragging.el.style.top=ny+"px";
  socket.emit("moveAvatar",{token:authToken,x:nx,y:ny});
}

/* ======== 🚪 Login ======== */
loginBtn.addEventListener("click",async()=>{
  setStatus(loginStatus,"Logge ein ...");
  const res=await fetch("/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:loginUser.value.trim(),password:loginPass.value.trim()})});
  const data=await res.json();
  if(!data.ok){setStatus(loginStatus,data.error,true);return;}
  authToken=data.token; myProfile=data.profile;
  setStatus(loginStatus,"Eingeloggt als "+myProfile.username+" ("+myProfile.role+")");
  afterLoginUI(); socket.emit("joinChat",authToken);
});

/* ======== 🦋 Registrierung ======== */
regBtn.addEventListener("click",async()=>{
  setStatus(regStatus,"Erstelle Account ...");
  const res=await fetch("/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({
    username:regUser.value.trim(),
    password:regPass.value.trim(),
    avatar:regAvatar.value.trim()||"🦋",
    color:regColor.value,
    language:regLang.value,
    theme:regTheme.value.trim()||"default"
  })});
  const data=await res.json();
  if(!data.ok){setStatus(regStatus,data.error,true);return;}
  setStatus(regStatus,"Account erstellt! Rolle: "+data.role+" — jetzt einloggen 💜");
});

/* ======== 💾 Profil ======== */
saveProfileBtn.addEventListener("click",async()=>{
  if(!authToken){setStatus(profileStatus,"Bitte erst einloggen 🙃",true);return;}
  const res=await fetch("/profile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({
    token:authToken,
    avatar:profAvatar.value.trim(),
    color:profColor.value,
    language:profLang.value,
    theme:profTheme.value.trim()
  })});
  const data=await res.json();
  if(!data.ok){setStatus(profileStatus,data.error,true);return;}
  myProfile=data.profile;
  setStatus(profileStatus,"Gespeichert 💜 Dein Style ist jetzt aktiv.");
});

/* ======== 🖋 UI nach Login ======== */
function afterLoginUI(){
  msgInput.disabled=false;
  sendBtn.disabled=false;
  profAvatar.value=myProfile.avatar||"🦋";
  profColor.value=myProfile.color||"#ffffff";
  profLang.value=myProfile.language||"de";
  profTheme.value=myProfile.theme||"default";
}

/* ======== 📩 Nachricht senden ======== */
msgInput.addEventListener("keydown",ev=>{
  if(ev.key==="Enter"&&!ev.shiftKey){
    ev.preventDefault();
    if(!sendBtn.disabled) sendBtn.click();
  }
});
sendBtn.addEventListener("click",()=>{
  if(!authToken){setStatus(loginStatus,"Bitte einloggen 💜",true);return;}
  const txt=msgInput.value.trim(); if(!txt)return;
  socket.emit("sendMessage",{token:authToken,text:txt});
  msgInput.value="";
});
</script>


