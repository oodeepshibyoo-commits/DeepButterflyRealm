<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>DeepButterfly Realm ðŸ’œðŸ‘‘</title>
<style>
body{
    margin:0;
    background:#0a0a0f;
    color:#fff;
    font-family:Arial,Helvetica,sans-serif;
    display:grid;
    grid-template-columns:260px 1fr;
    grid-template-rows:auto 220px 1fr auto;
    grid-template-areas:
        "side head"
        "side room"
        "side chat"
        "side input";
    height:100vh;
    overflow:hidden;
    position:relative;
}
/* HEADER */
header{
    grid-area:head;
    background:#1a1a24cc;
    border-bottom:2px solid #6b00ff;
    box-shadow:0 20px 60px rgba(255,77,253,.25),
               0 0 40px rgba(0,255,246,.25),
               0 0 120px rgba(107,0,255,.4);
    padding:.75rem 1rem;
    font-size:.8rem;
    line-height:1.4;
    text-align:center;
    z-index:10;
}
header .big{
    color:#ff4dfd;
    font-weight:600;
    text-shadow:0 0 10px #ff4dfd,0 0 20px #00fff6;
}
header .sub{
    color:#00fff6;
    font-size:.7rem;
    text-shadow:0 0 6px #00fff6;
}

/* SIDEBAR */
aside{
    grid-area:side;
    background:#1a1a24dd;
    border-right:2px solid #6b00ff;
    box-shadow:0 0 30px rgba(255,77,253,.3),
               0 0 80px rgba(0,255,246,.2);
    padding:.75rem;
    font-size:.75rem;
    overflow-y:auto;
    z-index:10;
}
h2{
    margin:.5rem 0 .25rem;
    font-size:.75rem;
    font-weight:600;
    color:#ff4dfd;
    text-shadow:0 0 6px #ff4dfd,0 0 10px #00fff6;
}
small{
    color:#8a8a9f;
    font-size:.7rem;
    line-height:1.4;
    display:block;
    margin-bottom:.5rem;
}
.block{
    border:2px solid #6b00ff;
    border-radius:10px;
    background:#2a2a38aa;
    box-shadow:0 0 16px rgba(107,0,255,.4),
               0 0 32px rgba(0,255,246,.2);
    padding:.5rem .75rem;
    margin-bottom:1rem;
    font-size:.7rem;
    line-height:1.4;
}

label{
    display:block;
    font-size:.7rem;
    font-weight:600;
    color:#fff;
    text-shadow:0 0 6px #fff,0 0 10px #00fff6;
    margin-bottom:.25rem;
}
input[type="text"],
input[type="password"],
input[type="color"],
select{
    width:100%;
    background:#2a2a38;
    color:#fff;
    border:2px solid #6b00ff;
    border-radius:8px;
    font-size:.7rem;
    padding:.4rem .5rem;
    margin-bottom:.5rem;
    box-shadow:0 0 12px rgba(107,0,255,.6),
               0 0 24px rgba(0,255,246,.4);
    outline:none;
}
button.btn{
    width:100%;
    background:radial-gradient(circle at 20% 20%, #ff4dfd 0%, #6b00ff 60%);
    border:0;
    border-radius:8px;
    color:#000;
    font-size:.75rem;
    font-weight:700;
    line-height:1.2;
    padding:.5rem .6rem;
    cursor:pointer;
    text-shadow:0 0 6px #fff,0 0 12px #00fff6;
    box-shadow:0 12px 30px rgba(255,77,253,.45),
               0 0 20px rgba(0,255,246,.4),
               0 0 60px rgba(107,0,255,.6);
    margin-bottom:.5rem;
}
button.btn:disabled{
    opacity:.4;
    cursor:not-allowed;
}
.statusLine{
    color:#8a8a9f;
    font-size:.7rem;
    line-height:1.4;
    min-height:2.8em;
    white-space:pre-wrap;
}

/* ONLINE LISTE */
#onlineList .userRow{
    border:2px solid #6b00ff;
    border-radius:8px;
    background:#2a2a38aa;
    box-shadow:0 0 12px rgba(107,0,255,.4),
               0 0 24px rgba(0,255,246,.2);
    padding:.5rem;
    margin-bottom:.5rem;
    line-height:1.3;
    cursor:pointer;
}
.nameLine{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:.4rem;
    font-weight:600;
}
.avatarEmoji{
    font-size:1rem;
    line-height:1rem;
    animation:bounce 2s ease-in-out infinite;
    text-shadow:0 0 8px #fff,0 0 12px #ff4dfd;
}
@keyframes bounce{
    0%   {transform:translateY(0) rotate(-2deg) scale(1);}
    25%  {transform:translateY(-2px) rotate(2deg) scale(1.05);}
    50%  {transform:translateY(0) rotate(-1deg) scale(1);}
    75%  {transform:translateY(-3px) rotate(3deg) scale(1.07);}
    100% {transform:translateY(0) rotate(-2deg) scale(1);}
}
.roleCrown{
    color:#ffd93b;
    text-shadow:0 0 6px #ffd93b,0 0 12px #ff4dfd;
    font-size:.8rem;
}
.metaLine{
    color:#aaa;
    font-size:.65rem;
}

/* RAUM OBEN */
#roomWrap{
    grid-area:room;
    background:#1a1a24dd;
    border-bottom:2px solid #6b00ff;
    box-shadow:0 0 30px rgba(255,77,253,.3),
               0 0 80px rgba(0,255,246,.2);
    position:relative;
    overflow:hidden;
    padding:.5rem .75rem .75rem;
    font-size:.7rem;
}
#roomTitle{
    color:#ff4dfd;
    font-weight:600;
    font-size:.75rem;
    text-shadow:0 0 10px #ff4dfd,0 0 20px #00fff6;
    margin-bottom:.5rem;
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
}
#roomArea{
    position:relative;
    width:100%;
    height:160px;
    border:2px solid #6b00ff;
    border-radius:10px;
    background:radial-gradient(circle at 20% 20%,rgba(107,0,255,.4)0%,rgba(0,0,0,.2)60%);
    box-shadow:0 0 20px rgba(107,0,255,.6),
               0 0 60px rgba(0,255,246,.2),
               0 0 120px rgba(255,77,253,.2);
    overflow:hidden;
}
.roomAvatar{
    position:absolute;
    cursor:grab;
    user-select:none;
    font-size:1.4rem;
    line-height:1.4rem;
    text-shadow:0 0 8px #fff,0 0 12px #ff4dfd;
    display:flex;
    flex-direction:column;
    align-items:center;
    font-weight:600;
    min-width:2rem;
    text-align:center;
}
.roomName{
    font-size:.6rem;
    margin-top:.25rem;
    text-shadow:0 0 6px #00fff6;
}
.roomCrown{
    color:#ffd93b;
    text-shadow:0 0 6px #ffd93b,0 0 12px #ff4dfd;
    font-size:.6rem;
    margin-left:.25rem;
}

/* CHAT FENSTER */
main{
    grid-area:chat;
    background:#1a1a24dd;
    box-shadow:0 0 30px rgba(255,77,253,.3),
               0 0 80px rgba(0,255,246,.2);
    display:flex;
    flex-direction:column;
    position:relative;
    overflow:hidden;
}
#messages{
    flex:1;
    overflow-y:auto;
    padding:1rem;
    font-family:Consolas,Menlo,monospace;
    font-size:.8rem;
    line-height:1.4;
}
.msgBubble{
    border:2px solid #6b00ff;
    background:#2a2a38;
    box-shadow:0 0 20px rgba(107,0,255,.4),
               0 0 40px rgba(0,255,246,.2);
    border-radius:10px;
    padding:.6rem .7rem;
    margin-bottom:.6rem;
    max-width:85%;
    white-space:pre-wrap;
    word-break:break-word;
}
.msgBubble.system{
    border-color:#444;
    background:#2a2a3844;
    box-shadow:none;
}
.msgHeader{
    font-weight:600;
    font-size:.7rem;
    margin-bottom:.4rem;
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:.4rem;
}
.msgHeaderName{
    text-shadow:0 0 8px #fff,0 0 12px #00fff6;
}
.msgHeaderName.systemName{
    color:#888 !important;
    text-shadow:none;
}
.msgHeaderRole{
    color:#ffd93b;
    text-shadow:0 0 6px #ffd93b,0 0 12px #ff4dfd;
    font-size:.7rem;
}
.msgOriginal{
    color:#bbb;
    margin-bottom:.4rem;
}
.msgArrow{
    color:#888;
    font-size:.7rem;
    margin-bottom:.3rem;
}
.msgTranslation{
    color:#fff;
    text-shadow:0 0 6px #fff,0 0 12px #00fff6;
    white-space:pre-wrap;
    word-break:break-word;
}

/* UNTEN: Nachricht schreiben */
footer{
    grid-area:input;
    background:#1a1a24cc;
    border-top:2px solid #6b00ff;
    box-shadow:0 -20px 60px rgba(255,77,253,.25),
               0 0 40px rgba(0,255,246,.25),
               0 0 120px rgba(107,0,255,.4);
    padding:.75rem;
    display:grid;
    grid-template-columns:1fr auto;
    gap:.5rem;
    align-items:flex-start;
}
#msgInput{
    width:100%;
    height:60px;
    resize:none;
    background:#2a2a38;
    color:#fff;
    border:2px solid #6b00ff;
    border-radius:8px;
    font-size:.8rem;
    line-height:1.3;
    font-family:Consolas,Menlo,monospace;
    padding:.6rem .7rem;
    box-shadow:inset 0 0 12px rgba(0,0,0,.6),
               0 0 20px rgba(107,0,255,.5);
    outline:none;
}
#sendBtn{
    background:radial-gradient(circle at 20% 20%, #00fff6 0%, #003d3d 60%);
    border:0;
    border-radius:10px;
    color:#00fff6;
    text-shadow:0 0 8px #00fff6,0 0 12px #ff4dfd;
    font-size:.8rem;
    font-weight:700;
    line-height:1.2;
    padding:.6rem .8rem;
    cursor:pointer;
    box-shadow:0 12px 30px rgba(0,255,246,.4),
               0 0 20px rgba(255,77,253,.4),
               0 0 60px rgba(107,0,255,.6);
    min-width:120px;
}
#sendBtn:disabled{
    opacity:.4;
    cursor:not-allowed;
}

/* GAME INFO */
#gameInfo{
    font-size:.7rem;
    line-height:1.4;
    color:#8a8a9f;
    margin-top:.5rem;
    border-top:1px solid #6b00ff;
    padding-top:.5rem;
}
#playTicTac{
    background:radial-gradient(circle at 20% 20%, #00fff6 0%, #003d3d 60%);
    border:0;
    border-radius:8px;
    color:#00fff6;
    text-shadow:0 0 8px #00fff6,0 0 12px #ff4dfd;
    font-size:.7rem;
    font-weight:700;
    line-height:1.2;
    padding:.4rem .6rem;
    cursor:pointer;
    box-shadow:0 12px 30px rgba(0,255,246,.4),
               0 0 20px rgba(255,77,253,.4),
               0 0 60px rgba(107,0,255,.6);
}

/* Hilfe-Box unter Registrierung */
#helpBox{
    border:1px solid #6b00ff;
    border-radius:8px;
    background:#1a1a24;
    box-shadow:0 0 16px rgba(107,0,255,.4),
               0 0 32px rgba(0,255,246,.2);
    padding:.5rem .6rem;
    font-size:.7rem;
    line-height:1.4;
    color:#fff;
    white-space:pre-wrap;
}
#helpBoxTitle{
    font-weight:600;
    color:#ff4dfd;
    text-shadow:0 0 8px #ff4dfd,0 0 12px #00fff6;
    margin-bottom:.4rem;
    font-size:.7rem;
}
</style>
</head>
<body>

<header>
    <div class="big">DeepButterfly Realm ðŸ’œðŸ‘‘</div>
    <div class="sub">Multilingual Â· Owner-Krone Â· Farben Â· Avatare Â· Raum ðŸ¦‹ Â· Moderation</div>
</header>

<aside>
    <div class="block">
        <h2>Login</h2>
        <label for="loginUser">Benutzername</label>
        <input id="loginUser" type="text" placeholder="z.B. DeepButterflyMusic" />
        <label for="loginPass">Passwort</label>
        <input id="loginPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
        <button class="btn" id="loginBtn">Einloggen</button>
        <div class="statusLine" id="loginStatus"></div>
    </div>

    <div class="block">
        <h2>Registrieren</h2>

        <!-- Sprachhilfe fÃ¼r neue User -->
        <label for="helpLangSelect">Hilfe-Sprache / SegÃ­tsÃ©g nyelve</label>
        <select id="helpLangSelect">
            <option value="de">Deutsch</option>
            <option value="hu">Magyar (Ungarisch)</option>
        </select>

        <div id="helpBox">
            <div id="helpBoxTitle">So meldest du dich an ðŸ’œ</div>
            <div id="helpBoxText">
1. WÃ¤hle einen Namen.
2. WÃ¤hle ein Passwort.
3. WÃ¤hle dein Avatar-Emoji (ðŸ¦‹ z.B.).
4. WÃ¤hle deine Farbe.
5. Sprache: Das ist, wie du Nachrichten lesen wirst.
6. Klick "Account erstellen".
Dann geh zu Login und melde dich damit an.
            </div>
        </div>

        <br/>

        <label for="regUser">Neuer Name</label>
        <input id="regUser" type="text" placeholder="z.B. DarkInfernal" />
        <label for="regPass">Passwort</label>
        <input id="regPass" type="password" placeholder="Passwort wÃ¤hlen" />

        <label for="regAvatar">Avatar Emoji / Symbol</label>
        <input id="regAvatar" type="text" value="ðŸ¦‹" />

        <label for="regColor">Name Farbe</label>
        <input id="regColor" type="color" value="#ff4dfd" />

        <label for="regLang">Sprache fÃ¼r Ãœbersetzung</label>
        <select id="regLang"></select>

        <label for="regTheme">Dein Style / Theme / Schrift</label>
        <input id="regTheme" type="text" placeholder="butterfly / fire / rose / neon ..." />

        <button class="btn" id="regBtn">Account erstellen</button>

        <div class="statusLine" id="regStatus"></div>

        <div id="gameInfo">
            <strong>Games (Beta)</strong><br/>
            Mini-Spiele kommen hier (z.B. TicTacToe).<br/>
            <button id="playTicTac">TicTacToe (bald)</button>
        </div>
    </div>

    <div class="block">
        <h2>Dein Profil</h2>
        <small>Dein Avatar / Farbe / Sprache / Style kannst du selber Ã¤ndern ðŸ’…</small>

        <label for="profAvatar">Avatar Emoji</label>
        <input id="profAvatar" type="text" />

        <label for="profColor">Name Farbe</label>
        <input id="profColor" type="color" value="#ffffff"/>

        <label for="profLang">Deine Sprache</label>
        <select id="profLang"></select>

        <label for="profTheme">Theme / Schrift</label>
        <input id="profTheme" type="text" placeholder="butterfly / fire / etc."/>

        <button class="btn" id="saveProfileBtn">Speichern</button>

        <div class="statusLine" id="profileStatus"></div>
    </div>

    <div class="block">
        <h2>Wer ist online?</h2>
        <small>Tippe auf einen Namen, wenn du Owner/Admin bist â†’ Admin machen / Kicken / Bannen</small>
        <div id="onlineList"></div>
    </div>
</aside>

<!-- RAUM OBEN -->
<div id="roomWrap">
    <div id="roomTitle">
        <span>Butterfly Room ðŸ¦‹ Alle Avatare in Echtzeit â€“ du kannst dich hinsetzen</span>
        <span style="color:#8a8a9f;font-size:.65rem;line-height:1.2;">
            Zieh dich wohin du willst ðŸ’–
        </span>
    </div>
    <div id="roomArea"></div>
</div>

<!-- CHAT -->
<main>
    <div id="messages"></div>
</main>

<!-- NACHRICHT SENDEN -->
<footer>
    <textarea id="msgInput" placeholder="Schreib hier... (Enter = senden, Shift+Enter = neue Zeile)" disabled></textarea>
    <button id="sendBtn" disabled>Senden</button>
</footer>

<script src="/socket.io/socket.io.js"></script>
<script>
// ===== Language config for translation of chat text =====
const LANGS = [
    {code:"de", name:"Deutsch"},
    {code:"hu", name:"Magyar / Ungarisch"},
    {code:"en", name:"English"},
    {code:"es", name:"EspaÃ±ol"},
    {code:"fr", name:"FranÃ§ais"},
    {code:"it", name:"Italiano"},
    {code:"pt", name:"PortuguÃªs"},
    {code:"tr", name:"TÃ¼rkÃ§e"},
    {code:"ru", name:"Ð ÑƒÑÑÐºÐ¸Ð¹"},
    {code:"ar", name:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"},
    {code:"zh", name:"ä¸­æ–‡"},
    {code:"ja", name:"æ—¥æœ¬èªž"}
];

const SERVERS = [
    "https://translate.astian.org/translate",
    "https://libretranslate.de/translate",
    "https://translate.fedilab.app/translate"
];

// Hilfe-Text fÃ¼r Registrierung in verschiedenen Sprachen
const HELP_TEXT = {
    de: {
        title: "So meldest du dich an ðŸ’œ",
        body:
`1. WÃ¤hle einen Namen.
2. WÃ¤hle ein Passwort.
3. WÃ¤hle dein Avatar-Emoji (ðŸ¦‹ z.B.).
4. WÃ¤hle deine Farbe.
5. Sprache: Das ist, wie du Nachrichten lesen wirst.
6. Klick "Account erstellen".

Dann geh zu Login und melde dich damit an.

Der ERSTE Account wird Owner ðŸ‘‘.
Owner/Admin kÃ¶nnen Leute kicken oder bannen.`
    },
    hu: {
        title: "Ãgy tudsz belÃ©pni ðŸ’œ",
        body:
`1. VÃ¡lassz nevet.
2. VÃ¡lassz jelszÃ³t.
3. VÃ¡lassz avatar emojit (pl. ðŸ¦‹).
4. VÃ¡lassz nÃ©vszÃ­nt.
5. Nyelv: ezen a nyelven lÃ¡tod majd az Ã¼zeneteket.
6. Kattints: "FiÃ³k lÃ©trehozÃ¡sa".

UtÃ¡na menj a Login rÃ©szhez Ã©s jelentkezz be.

Az ELSÅ felhasznÃ¡lÃ³ lesz az Owner ðŸ‘‘.
Az Owner / Admin ki tud rÃºgni vagy tiltani mÃ¡sokat.`
    }
};

// DOM refs
const loginUser = document.getElementById("loginUser");
const loginPass = document.getElementById("loginPass");
const loginBtn  = document.getElementById("loginBtn");
const loginStatus = document.getElementById("loginStatus");

const regUser = document.getElementById("regUser");
const regPass = document.getElementById("regPass");
const regAvatar = document.getElementById("regAvatar");
const regColor = document.getElementById("regColor");
const regLang  = document.getElementById("regLang");
const regTheme = document.getElementById("regTheme");
const regBtn   = document.getElementById("regBtn");
const regStatus= document.getElementById("regStatus");

const profAvatar = document.getElementById("profAvatar");
const profColor  = document.getElementById("profColor");
const profLang   = document.getElementById("profLang");
const profTheme  = document.getElementById("profTheme");
const saveProfileBtn = document.getElementById("saveProfileBtn");
const profileStatus  = document.getElementById("profileStatus");

const onlineList = document.getElementById("onlineList");

const messagesEl = document.getElementById("messages");
const msgInput   = document.getElementById("msgInput");
const sendBtn    = document.getElementById("sendBtn");

const roomArea   = document.getElementById("roomArea");
const playTicTac = document.getElementById("playTicTac");

const helpLangSelect = document.getElementById("helpLangSelect");
const helpBoxTitle   = document.getElementById("helpBoxTitle");
const helpBoxText    = document.getElementById("helpBoxText");

// Sprache Auswahl setzen (fÃ¼r Ãœbersetzung / Profil)
function fillLangSelect(sel){
    LANGS.forEach(l=>{
        const o=document.createElement("option");
        o.value=l.code;
        o.textContent=l.name;
        sel.appendChild(o);
    });
}
fillLangSelect(regLang);
fillLangSelect(profLang);

// state
let authToken = null;
let myProfile = null;
let dragging = null; // { username, el, offsetX, offsetY }
let currentRoomState = {}; // username -> {x,y,avatar,color,role}

// helpers
function setStatus(el, msg, isErr=false){
    el.textContent = msg;
    el.style.color = isErr ? "#ff4dfd" : "#8a8a9f";
}
function fixGermanQuick(t){
    return t
        .replace(/\bich libe dich\b/gi,"ich liebe dich")
        .replace(/\bich libe dich so se(h|r)+\b/gi,"ich liebe dich so sehr")
        .replace(/wi[e] gehts dir/gi,"wie geht es dir")
        .replace(/wo bist du+\b/gi,"wo bist du");
}
async function translateTextSmart(rawText, tgtLang){
    const key = "cache|"+tgtLang+"|"+rawText;
    const cache = sessionStorage.getItem(key);
    if(cache) return cache;

    let translated=null;
    for(const url of SERVERS){
        try{
            const res=await fetch(url,{
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body:JSON.stringify({
                    q: rawText,
                    source:"auto",
                    target:tgtLang,
                    format:"text"
                })
            });
            if(!res.ok) continue;
            const data=await res.json();
            if(data && data.translatedText){
                translated=data.translatedText;
                break;
            }
        }catch(e){}
    }
    if(!translated){
        translated="(konnte nicht Ã¼bersetzen ðŸ˜¢)";
    }
    sessionStorage.setItem(key,translated);
    return translated;
}

// CHAT anzeigen
async function addMessageBubble(msg){
    const isSystem = (msg.from==="System");
    const wrap = document.createElement("div");
    wrap.className="msgBubble"+(isSystem?" system":"");

    const head=document.createElement("div");
    head.className="msgHeader";

    const avSpan=document.createElement("span");
    avSpan.className="avatarEmoji";
    avSpan.textContent=msg.avatar || "ðŸ’¬";

    const nameSpan=document.createElement("span");
    nameSpan.className="msgHeaderName";
    nameSpan.textContent=msg.from;
    if(isSystem){
        nameSpan.classList.add("systemName");
        nameSpan.style.color="#888";
        nameSpan.style.textShadow="none";
    } else if(msg.color){
        nameSpan.style.color=msg.color;
        nameSpan.style.textShadow=`0 0 6px ${msg.color},0 0 12px #00fff6`;
    }

    head.appendChild(avSpan);
    head.appendChild(nameSpan);

    if(msg.role==="owner"||msg.role==="admin"){
        const rSpan=document.createElement("span");
        rSpan.className="msgHeaderRole";
        rSpan.textContent="ðŸ‘‘";
        head.appendChild(rSpan);
    }

    wrap.appendChild(head);

    const orig=document.createElement("div");
    orig.className="msgOriginal";
    orig.textContent=msg.text;
    wrap.appendChild(orig);

    if(!isSystem && myProfile){
        const arr=document.createElement("div");
        arr.className="msgArrow";
        arr.textContent="â†’ Ã¼bersetzt fÃ¼r dich:";
        wrap.appendChild(arr);

        const trans=document.createElement("div");
        trans.className="msgTranslation";
        trans.textContent="(Ã¼bersetze ...)";
        wrap.appendChild(trans);

        const t = await translateTextSmart(msg.text, myProfile.language || "de");
        trans.textContent=t;
    }

    messagesEl.appendChild(wrap);
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

// ONLINE LISTE
function renderOnlineList(arr){
    onlineList.innerHTML="";
    arr.forEach(u=>{
        const row=document.createElement("div");
        row.className="userRow";

        const line1=document.createElement("div");
        line1.className="nameLine";

        const av=document.createElement("span");
        av.className="avatarEmoji";
        av.textContent=u.avatar||"â­";

        const nm=document.createElement("span");
        nm.textContent=u.username;
        nm.style.color=u.color||"#fff";
        nm.style.fontWeight="600";
        nm.style.textShadow=`0 0 6px ${u.color||"#fff"},0 0 10px #ff4dfd`;

        line1.appendChild(av);
        line1.appendChild(nm);

        if(u.role==="owner"||u.role==="admin"){
            const cr=document.createElement("span");
            cr.className="roleCrown";
            cr.textContent="ðŸ‘‘";
            line1.appendChild(cr);
        }

        const line2=document.createElement("div");
        line2.className="metaLine";
        line2.textContent="Online Â· Sprache: "+(u.language||"?");

        row.appendChild(line1);
        row.appendChild(line2);

        // Moderation-MenÃ¼ beim Klicken (nur Owner/Admin)
        row.addEventListener("click", ()=>{
            if(!myProfile) return;
            const iAmMod = (myProfile.role==="owner" || myProfile.role==="admin");
            if(!iAmMod) return;
            if(myProfile.username === u.username) return; // sich selbst nicht

            const choice = prompt(
                "Aktion fÃ¼r "+u.username+"?\n" +
                "1 = Admin machen (nur Owner)\n" +
                "2 = Kicken (rauswerfen)\n" +
                "3 = Bannen (nie wieder rein)\n" +
                "Andere Taste = Abbrechen"
            );
            if(choice==="1"){
                socket.emit("promoteAdmin",{
                    token: authToken,
                    targetUser: u.username
                });
            } else if(choice==="2"){
                socket.emit("kickUser",{
                    token: authToken,
                    targetUser: u.username
                });
            } else if(choice==="3"){
                socket.emit("banUser",{
                    token: authToken,
                    targetUser: u.username
                });
            }
        });

        onlineList.appendChild(row);
    });
}

// RAUM rendern (Avatare bewegen)
function renderRoom(){
    roomArea.innerHTML="";
    for(const username in currentRoomState){
        const info = currentRoomState[username];
        const box = document.createElement("div");
        box.className="roomAvatar";
        box.style.left = (info.x||20)+"px";
        box.style.top  = (info.y||20)+"px";

        const face = document.createElement("div");
        face.textContent = info.avatar || "â­";
        face.style.textShadow = `0 0 8px ${info.color||"#fff"},0 0 12px #ff4dfd`;

        const nameLine=document.createElement("div");
        nameLine.className="roomName";
        nameLine.style.color = info.color || "#fff";
        nameLine.style.textShadow = `0 0 6px ${info.color||"#fff"},0 0 10px #00fff6`;
        nameLine.textContent=username;
        if(info.role==="owner"||info.role==="admin"){
            const crown=document.createElement("span");
            crown.className="roomCrown";
            crown.textContent="ðŸ‘‘";
            nameLine.appendChild(crown);
        }

        box.appendChild(face);
        box.appendChild(nameLine);

        // nur MEIN Avatar darf ich ziehen
        if(myProfile && username===myProfile.username){
            box.addEventListener("mousedown",(ev)=>{
                dragging = {
                    username,
                    el: box,
                    offsetX: ev.offsetX,
                    offsetY: ev.offsetY
                };
            });
            box.addEventListener("touchstart",(ev)=>{
                const t = ev.touches[0];
                const rect = box.getBoundingClientRect();
                dragging = {
                    username,
                    el: box,
                    offsetX: t.clientX - rect.left,
                    offsetY: t.clientY - rect.top
                };
            }, {passive:false});
        }

        roomArea.appendChild(box);
    }
}

// Avatar ziehen -> Server updaten
function onMovePointer(clientX, clientY){
    if(!dragging || !myProfile) return;
    if(dragging.username !== myProfile.username) return;

    const bounds = roomArea.getBoundingClientRect();
    let newX = clientX - bounds.left - dragging.offsetX;
    let newY = clientY - bounds.top  - dragging.offsetY;

    if(newX < 0) newX = 0;
    if(newY < 0) newY = 0;
    if(newX > bounds.width-40) newX = bounds.width-40;
    if(newY > bounds.height-40) newY = bounds.height-40;

    dragging.el.style.left = newX+"px";
    dragging.el.style.top  = newY+"px";

    socket.emit("moveAvatar",{
        token: authToken,
        x: newX,
        y: newY
    });
}

window.addEventListener("mousemove",(ev)=>onMovePointer(ev.clientX,ev.clientY));
window.addEventListener("touchmove",(ev)=>{
    if(ev.touches && ev.touches[0]){
        onMovePointer(ev.touches[0].clientX, ev.touches[0].clientY);
    }
},{passive:false});
window.addEventListener("mouseup",()=>{ dragging=null; });
window.addEventListener("touchend",()=>{ dragging=null; });

// SOCKET.IO
const socket = io();

socket.on("chatMessage",(msg)=>{
    addMessageBubble(msg);
});

socket.on("userlist",(arr)=>{
    renderOnlineList(arr);
});

socket.on("roomUpdate",(state)=>{
    currentRoomState = state || {};
    renderRoom();
});

socket.on("forceLogout",(data)=>{
    alert(data?.reason || "Du wurdest getrennt.");
    // Reset local
    authToken = null;
    myProfile = null;
    msgInput.disabled = true;
    sendBtn.disabled  = true;
    loginStatus.textContent = "Du wurdest entfernt.";
});

// nach login dem server sagen "ich bin da"
function joinChatAfterLogin(){
    if(!authToken) return;
    socket.emit("joinChat", authToken);
}

// LOGIN
loginBtn.addEventListener("click", async ()=>{
    setStatus(loginStatus,"Logge ein ...");
    try{
        const res=await fetch("/login",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({
                username: loginUser.value.trim(),
                password: loginPass.value.trim()
            })
        });
        const data=await res.json();
        if(!data.ok){
            setStatus(loginStatus,data.error||"Fehler",true);
            return;
        }
        authToken=data.token;
        myProfile=data.profile;
        setStatus(loginStatus,"Eingeloggt als "+myProfile.username+" ("+myProfile.role+")");
        afterLoginUI();
        joinChatAfterLogin();
    }catch(e){
        setStatus(loginStatus,"Netzwerk-Fehler",true);
    }
});

// REGISTRIEREN
regBtn.addEventListener("click", async ()=>{
    setStatus(regStatus,"Erstelle Account ...");
    try{
        const res=await fetch("/register",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({
                username: regUser.value.trim(),
                password: regPass.value.trim(),
                avatar:   regAvatar.value.trim() || "ðŸ¦‹",
                color:    regColor.value,
                language: regLang.value,
                theme:    regTheme.value.trim() || "default"
            })
        });
        const data=await res.json();
        if(!data.ok){
            setStatus(regStatus,data.error||"Fehler",true);
            return;
        }
        setStatus(regStatus,"Account erstellt!\nRolle: "+data.role+"\nJetzt einloggen ðŸ’œ");
    }catch(e){
        setStatus(regStatus,"Netzwerk-Fehler",true);
    }
});

// PROFIL speichern
saveProfileBtn.addEventListener("click", async ()=>{
    if(!authToken){
        setStatus(profileStatus,"Du bist nicht eingeloggt ðŸ™ƒ",true);
        return;
    }
    setStatus(profileStatus,"Speichere...");
    try{
        const res=await fetch("/profile",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({
                token: authToken,
                avatar: profAvatar.value.trim(),
                color:  profColor.value,
                language: profLang.value,
                theme: profTheme.value.trim()
            })
        });
        const data=await res.json();
        if(!data.ok){
            setStatus(profileStatus,data.error||"Fehler",true);
            return;
        }
        myProfile=data.profile;
        setStatus(profileStatus,"Gespeichert ðŸ’œ Dein Style ist jetzt aktiv.");
    }catch(e){
        setStatus(profileStatus,"Netzwerk-Fehler",true);
    }
});

// UI nach Login
function afterLoginUI(){
    if(!myProfile) return;

    msgInput.disabled=false;
    sendBtn.disabled=false;

    profAvatar.value = myProfile.avatar || "ðŸ¦‹";
    profColor.value  = myProfile.color || "#ffffff";
    profLang.value   = myProfile.language || "de";
    profTheme.value  = myProfile.theme || "default";

    setStatus(profileStatus,"Dein Profil ist geladen ðŸ’œ");
    setStatus(loginStatus,"Eingeloggt als "+myProfile.username+" ("+myProfile.role+")");
}

// ENTER zum Senden
msgInput.addEventListener("keydown",(ev)=>{
    if (ev.key === "Enter" && !ev.shiftKey){
        ev.preventDefault();
        // direkt senden wie WhatsApp
        if(!sendBtn.disabled){
            sendBtn.click();
        }
    }
    // Shift+Enter macht normale neue Zeile (wir blocken das nicht)
});

// Senden Button
sendBtn.addEventListener("click", ()=>{
    if(!authToken){
        setStatus(loginStatus,"Bitte erst einloggen ðŸ’œ",true);
        return;
    }
    let txt = msgInput.value.trim();
    if(!txt){
        return;
    }
    txt = fixGermanQuick(txt);

    socket.emit("sendMessage", {
        token: authToken,
        text: txt
    });

    msgInput.value="";
    msgInput.focus();
});

// game button (platzhalter)
playTicTac.addEventListener("click", ()=>{
    alert("TicTacToe (2 Spieler) kommt bald ðŸ¦‹ðŸ’œ");
});

// Hilfe-Sprache wechseln (Deutsch / Ungarisch)
helpLangSelect.addEventListener("change", ()=>{
    const lang = helpLangSelect.value;
    const pack = HELP_TEXT[lang] || HELP_TEXT.de;
    helpBoxTitle.textContent = pack.title;
    helpBoxText.textContent  = pack.body;
});
</script>
</body>
</html>
