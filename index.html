<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>DeepButterfly Realm 3.0 üíúüëë</title>
<style>
/* --- Neon Dark Layout --- */
body{
    margin:0;
    background:#050505;
    color:#fff;
    font-family:Arial,Helvetica,sans-serif;
    display:grid;
    grid-template-columns:260px 1fr;
    grid-template-rows:auto 220px 1fr auto auto;
    grid-template-areas:
        "side head"
        "side room"
        "side chat"
        "side input"
        "side game";
    height:100vh;
    overflow:hidden;
    position:relative;
}

/* Pinke Neon-Uhr oben rechts */
#clockTop{
    position:fixed;
    right:20px;
    top:10px;
    z-index:9999;
    color:#ff4dfd;
    font-size:.7rem;
    font-weight:600;
    text-shadow:0 0 8px #ff4dfd,0 0 12px #00fff6;
    font-family:Consolas,Menlo,monospace;
}

/* HEADER */
header{
    grid-area:head;
    background:#1a1a24cc;
    border-bottom:2px solid #6b00ff;
    box-shadow:0 20px 60px rgba(255,77,253,.25),
               0 0 40px rgba(0,255,246,.25),
               0 0 120px rgba(107,0,255,.4);
    padding:.75rem 1rem;
    font-size:.8rem;
    line-height:1.4;
    text-align:center;
    z-index:10;
}
header .big{
    color:#ff4dfd;
    font-weight:600;
    text-shadow:0 0 10px #ff4dfd,0 0 20px #00fff6;
}
header .sub{
    color:#00fff6;
    font-size:.7rem;
    text-shadow:0 0 6px #00fff6;
}

/* SIDEBAR */
aside{
    grid-area:side;
    background:#1a1a24dd;
    border-right:2px solid #6b00ff;
    box-shadow:0 0 30px rgba(255,77,253,.3),
               0 0 80px rgba(0,255,246,.2);
    padding:.75rem;
    font-size:.75rem;
    overflow-y:auto;
    z-index:10;
}
h2{
    margin:.5rem 0 .25rem;
    font-size:.75rem;
    font-weight:600;
    color:#ff4dfd;
    text-shadow:0 0 6px #ff4dfd,0 0 10px #00fff6;
}
small{
    color:#8a8a9f;
    font-size:.7rem;
    line-height:1.4;
    display:block;
    margin-bottom:.5rem;
}
.block{
    border:2px solid #6b00ff;
    border-radius:10px;
    background:#2a2a38aa;
    box-shadow:0 0 16px rgba(107,0,255,.4),
               0 0 32px rgba(0,255,246,.2);
    padding:.5rem .75rem;
    margin-bottom:1rem;
    font-size:.7rem;
    line-height:1.4;
}

/* BUTTONS */
button.btn,button.smallBtn{
    background:radial-gradient(circle at 20% 20%, #ff4dfd 0%, #6b00ff 60%);
    border:0;
    border-radius:8px;
    color:#000;
    font-size:.75rem;
    font-weight:700;
    padding:.5rem .6rem;
    cursor:pointer;
    text-shadow:0 0 6px #fff,0 0 12px #00fff6;
    box-shadow:0 12px 30px rgba(255,77,253,.45),
               0 0 20px rgba(0,255,246,.4),
               0 0 60px rgba(107,0,255,.6);
    margin-bottom:.5rem;
}
button.btn:disabled{opacity:.4;cursor:not-allowed;}
.smallBtn{font-size:.65rem;padding:.4rem .5rem;}

/* ONLINE LISTE */
#onlineList .userRow{
    border:2px solid #6b00ff;
    border-radius:8px;
    background:#2a2a38aa;
    box-shadow:0 0 12px rgba(107,0,255,.4),
               0 0 24px rgba(0,255,246,.2);
    padding:.5rem;
    margin-bottom:.5rem;
    line-height:1.3;
    cursor:pointer;
}
.nameLine{display:flex;align-items:center;gap:.4rem;}
.avatarEmoji{font-size:1rem;text-shadow:0 0 8px #fff,0 0 12px #ff4dfd;}
.roleCrown{color:#ffd93b;text-shadow:0 0 6px #ffd93b,0 0 12px #ff4dfd;}

/* RAUM */
#roomWrap{grid-area:room;background:#1a1a24dd;border-bottom:2px solid #6b00ff;padding:.5rem;}
#roomArea{position:relative;width:100%;height:160px;border:2px solid #6b00ff;border-radius:10px;overflow:hidden;}
.roomAvatar{position:absolute;cursor:grab;user-select:none;font-size:1.4rem;text-align:center;}
.roomName{font-size:.6rem;margin-top:.25rem;text-shadow:0 0 6px #00fff6;}
.roomCrown{color:#ffd93b;text-shadow:0 0 6px #ffd93b,0 0 12px #ff4dfd;font-size:.6rem;}

/* CHAT */
main{grid-area:chat;background:#1a1a24dd;display:flex;flex-direction:column;}
#messages{flex:1;overflow-y:auto;padding:1rem;font-family:Consolas,Menlo,monospace;font-size:.8rem;}
.msgBubble{border:2px solid #6b00ff;background:#2a2a38;border-radius:10px;padding:.6rem;margin-bottom:.6rem;}
.msgInfoLine{font-size:.65rem;color:#ff4dfd;text-shadow:0 0 8px #ff4dfd,0 0 12px #00fff6;}
.msgTranslation{color:#fff;text-shadow:0 0 6px #fff,0 0 12px #00fff6;}

/* INPUT */
footer{grid-area:input;background:#1a1a24cc;border-top:2px solid #6b00ff;padding:.75rem;display:grid;grid-template-columns:1fr auto;gap:.5rem;}
#msgInput{height:60px;background:#2a2a38;color:#fff;border:2px solid #6b00ff;border-radius:8px;font-family:Consolas,Menlo,monospace;}
#sendBtn{background:radial-gradient(circle at 20% 20%, #00fff6 0%, #003d3d 60%);border:0;border-radius:10px;color:#00fff6;font-weight:700;cursor:pointer;}

/* GAME ROOM */
#gameRoomWrap{grid-area:game;background:#0f0f14dd;border-top:2px solid #6b00ff;padding:.75rem;font-size:.7rem;}
</style>
</head>
<body>

<div id="clockTop">--:--</div>

<header>
    <div class="big">DeepButterfly Realm 3.0 üíúüëë</div>
    <div class="sub">Multilingual ¬∑ Owner-Krone ¬∑ Avatare ¬∑ Sitzen ¬∑ Spiele ¬∑ Uhrzeit üíñ</div>
</header>

<aside id="asideBox">
    <!-- LOGIN -->
    <div class="block">
        <h2>Login</h2>
        <input id="loginUser" type="text" placeholder="Name"/>
        <input id="loginPass" type="password" placeholder="Passwort"/>
        <button id="loginBtn" class="btn">Einloggen</button>
        <div id="loginStatus"></div>
    </div>

    <!-- ONLINE USERS -->
    <div class="block">
        <h2>Wer ist online?</h2>
        <div id="onlineList"></div>
    </div>

    <!-- ADMIN -->
    <div class="block" id="adminPanel" style="display:none;">
        <h2>Admin</h2>
        <div class="targetName">Kein Ziel ausgew√§hlt</div>
        <button id="fixOwnerBtn" class="smallBtn">üëë Owner fixen</button>
        <button id="makeCoOwnerBtn" class="smallBtn">üëë Mitbesitzer</button>
        <button id="removeCoOwnerBtn" class="smallBtn">üíî Entfernen</button>
        <button id="kickBtn" class="smallBtn">üö´ Kick</button>
        <button id="banBtn" class="smallBtn">‚ùå Ban</button>
        <div id="adminStatus"></div>
    </div>
</aside>

<div id="roomWrap"><div id="roomArea"></div></div>
<main><div id="messages"></div></main>
<footer><textarea id="msgInput" disabled></textarea><button id="sendBtn" disabled>Senden</button></footer>
<section id="gameRoomWrap">üïπ Spielraum</section>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const asideEl = document.getElementById("asideBox");
const loginUser=document.getElementById("loginUser");
const loginPass=document.getElementById("loginPass");
const loginBtn=document.getElementById("loginBtn");
const loginStatus=document.getElementById("loginStatus");
const messagesEl=document.getElementById("messages");
const msgInput=document.getElementById("msgInput");
const sendBtn=document.getElementById("sendBtn");
const onlineList=document.getElementById("onlineList");
const adminPanel=document.getElementById("adminPanel");
const adminStatus=document.getElementById("adminStatus");
const clockTopEl=document.getElementById("clockTop");

let authToken=null;
let myProfile=null;

/* --- Uhrzeit --- */
function updateClockTop(){
  const d=new Date();
  clockTopEl.textContent=d.toLocaleString();
}
setInterval(updateClockTop,1000);

/* --- Google Translate --- */
const GOOGLE_API_KEY="AIzaSyCPVLOrz0B2P_k6Tr6SFMSeup0GttsGNXE";
async function translateAuto(text,targetLang){
  try{
    const res=await fetch("https://translation.googleapis.com/language/translate/v2?key="+GOOGLE_API_KEY,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({q:text,target:targetLang})
    });
    const data=await res.json();
    if(data?.data?.translations?.[0]?.translatedText){
      return {
        translatedText:data.data.translations[0].translatedText,
        detectedSource:data.data.translations[0].detectedSourceLanguage||"auto"
      };
    }
  }catch(e){console.error(e);}
  return {translatedText:text,detectedSource:"auto"};
}

/* --- Chat Nachricht anzeigen --- */
async function addMessageBubble(msg){
  const wrap=document.createElement("div");
  wrap.className="msgBubble";
  wrap.innerHTML=`<b style="color:${msg.color||'#fff'}">${msg.avatar||'üí¨'} ${msg.from}</b><br>${msg.text}`;
  if(myProfile){
    const myLang=myProfile.language||"de";
    const r=await translateAuto(msg.text,myLang);
    const info=document.createElement("div");
    info.className="msgInfoLine";
    info.textContent=`√úbersetzt aus: ${r.detectedSource} ‚Üí ${myLang}`;
    const trans=document.createElement("div");
    trans.className="msgTranslation";
    trans.textContent=r.translatedText;
    wrap.appendChild(info);
    wrap.appendChild(trans);
  }
  messagesEl.appendChild(wrap);
  messagesEl.scrollTop=messagesEl.scrollHeight;
}

/* --- Sichtbarkeit Sidebar bis Login --- */
asideEl.style.filter="blur(5px)";
asideEl.style.pointerEvents="none";

/* --- Nach Login freigeben --- */
function afterLoginUI(){
  msgInput.disabled=false;
  sendBtn.disabled=false;
  asideEl.style.filter="none";
  asideEl.style.pointerEvents="auto";
  if(myProfile.role==="owner"||myProfile.role==="coOwner"||myProfile.role==="admin"){
    adminPanel.style.display="block";
  }else adminPanel.style.display="none";
}

/* --- Login --- */
loginBtn.onclick=async()=>{
  loginStatus.textContent="Logge ein...";
  const res=await fetch("/login",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username:loginUser.value,password:loginPass.value})
  });
  const data=await res.json();
  if(!data.ok){loginStatus.textContent=data.error||"Fehler";return;}
  authToken=data.token;
  myProfile=data.profile;
  loginStatus.textContent="Eingeloggt als "+myProfile.username;
  afterLoginUI();
  socket.emit("joinChat",authToken);
};

/* --- Chat senden --- */
sendBtn.onclick=()=>{
  const t=msgInput.value.trim();
  if(!t)return;
  socket.emit("sendMessage",{token:authToken,text:t});
  msgInput.value="";
};

/* --- Socket Events --- */
socket.on("chatMessage",m=>addMessageBubble(m));
socket.on("userlist",arr=>{
  onlineList.innerHTML="";
  arr.forEach(u=>{
    const d=document.createElement("div");
    d.className="userRow";
    d.textContent=u.avatar+" "+u.username+" ("+u.language+")";
    onlineList.appendChild(d);
  });
});
</script>
</body>
</html>

