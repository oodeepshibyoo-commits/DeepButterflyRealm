<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>DeepButterfly Realm üíúüëë</title>
<style>
body{
    margin:0;
    background:#0a0a0f;
    color:#fff;
    font-family:Arial,Helvetica,sans-serif;
    display:grid;
    grid-template-columns:260px 1fr;
    grid-template-rows:auto 1fr auto;
    grid-template-areas:
        "side head"
        "side chat"
        "side input";
    height:100vh;
    overflow:hidden;
    position:relative;
}
header{
    grid-area:head;
    background:#1a1a24cc;
    border-bottom:2px solid #6b00ff;
    box-shadow:0 20px 60px rgba(255,77,253,.25),
               0 0 40px rgba(0,255,246,.25),
               0 0 120px rgba(107,0,255,.4);
    padding:.75rem 1rem;
    font-size:.8rem;
    line-height:1.4;
    text-align:center;
    z-index:10;
}
header .big{
    color:#ff4dfd;
    font-weight:600;
    text-shadow:0 0 10px #ff4dfd,0 0 20px #00fff6;
}
header .sub{
    color:#00fff6;
    font-size:.7rem;
    text-shadow:0 0 6px #00fff6;
}

aside{
    grid-area:side;
    background:#1a1a24dd;
    border-right:2px solid #6b00ff;
    box-shadow:0 0 30px rgba(255,77,253,.3),
               0 0 80px rgba(0,255,246,.2);
    padding:.75rem;
    font-size:.75rem;
    overflow-y:auto;
    z-index:10;
}

h2{
    margin:.5rem 0 .25rem;
    font-size:.75rem;
    font-weight:600;
    color:#ff4dfd;
    text-shadow:0 0 6px #ff4dfd,0 0 10px #00fff6;
}
small{
    color:#8a8a9f;
    font-size:.7rem;
    line-height:1.4;
    display:block;
    margin-bottom:.5rem;
}

.block{
    border:2px solid #6b00ff;
    border-radius:10px;
    background:#2a2a38aa;
    box-shadow:0 0 16px rgba(107,0,255,.4),
               0 0 32px rgba(0,255,246,.2);
    padding:.5rem .75rem;
    margin-bottom:1rem;
    font-size:.7rem;
    line-height:1.4;
}

label{
    display:block;
    font-size:.7rem;
    font-weight:600;
    color:#fff;
    text-shadow:0 0 6px #fff,0 0 10px #00fff6;
    margin-bottom:.25rem;
}
input[type="text"],
input[type="password"],
input[type="color"],
select{
    width:100%;
    background:#2a2a38;
    color:#fff;
    border:2px solid #6b00ff;
    border-radius:8px;
    font-size:.7rem;
    padding:.4rem .5rem;
    margin-bottom:.5rem;
    box-shadow:0 0 12px rgba(107,0,255,.6),
               0 0 24px rgba(0,255,246,.4);
    outline:none;
}

button.btn{
    width:100%;
    background:radial-gradient(circle at 20% 20%, #ff4dfd 0%, #6b00ff 60%);
    border:0;
    border-radius:8px;
    color:#000;
    font-size:.75rem;
    font-weight:700;
    line-height:1.2;
    padding:.5rem .6rem;
    cursor:pointer;
    text-shadow:0 0 6px #fff,0 0 12px #00fff6;
    box-shadow:0 12px 30px rgba(255,77,253,.45),
               0 0 20px rgba(0,255,246,.4),
               0 0 60px rgba(107,0,255,.6);
    margin-bottom:.5rem;
}
button.btn:disabled{
    opacity:.4;
    cursor:not-allowed;
}

.statusLine{
    color:#8a8a9f;
    font-size:.7rem;
    line-height:1.4;
    min-height:2.8em;
    white-space:pre-wrap;
}

#onlineList .userRow{
    border:2px solid #6b00ff;
    border-radius:8px;
    background:#2a2a38aa;
    box-shadow:0 0 12px rgba(107,0,255,.4),
               0 0 24px rgba(0,255,246,.2);
    padding:.5rem;
    margin-bottom:.5rem;
    line-height:1.3;
}
.nameLine{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:.4rem;
    font-weight:600;
}
.avatarEmoji{
    font-size:1rem;
    line-height:1rem;
    animation:bounce 2s ease-in-out infinite;
    text-shadow:0 0 8px #fff,0 0 12px #ff4dfd;
}
@keyframes bounce{
    0%   {transform:translateY(0) rotate(-2deg) scale(1);}
    25%  {transform:translateY(-2px) rotate(2deg) scale(1.05);}
    50%  {transform:translateY(0) rotate(-1deg) scale(1);}
    75%  {transform:translateY(-3px) rotate(3deg) scale(1.07);}
    100% {transform:translateY(0) rotate(-2deg) scale(1);}
}
.roleCrown{
    color:#ffd93b;
    text-shadow:0 0 6px #ffd93b,0 0 12px #ff4dfd;
    font-size:.8rem;
}
.metaLine{
    color:#aaa;
    font-size:.65rem;
}

main{
    grid-area:chat;
    background:#1a1a24dd;
    box-shadow:0 0 30px rgba(255,77,253,.3),
               0 0 80px rgba(0,255,246,.2);
    display:flex;
    flex-direction:column;
    position:relative;
    overflow:hidden;
}
#messages{
    flex:1;
    overflow-y:auto;
    padding:1rem;
    font-family:Consolas,Menlo,monospace;
    font-size:.8rem;
    line-height:1.4;
}
.msgBubble{
    border:2px solid #6b00ff;
    background:#2a2a38;
    box-shadow:0 0 20px rgba(107,0,255,.4),
               0 0 40px rgba(0,255,246,.2);
    border-radius:10px;
    padding:.6rem .7rem;
    margin-bottom:.6rem;
    max-width:85%;
    white-space:pre-wrap;
    word-break:break-word;
}
.msgBubble.system{
    border-color:#444;
    background:#2a2a3844;
    box-shadow:none;
}
.msgHeader{
    font-weight:600;
    font-size:.7rem;
    margin-bottom:.4rem;
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:.4rem;
}
.msgHeaderName{
    text-shadow:0 0 8px #fff,0 0 12px #00fff6;
}
.msgHeaderName.systemName{
    color:#888 !important;
    text-shadow:none;
}
.msgHeaderRole{
    color:#ffd93b;
    text-shadow:0 0 6px #ffd93b,0 0 12px #ff4dfd;
    font-size:.7rem;
}
.msgOriginal{
    color:#bbb;
    margin-bottom:.4rem;
}
.msgArrow{
    color:#888;
    font-size:.7rem;
    margin-bottom:.3rem;
}
.msgTranslation{
    color:#fff;
    text-shadow:0 0 6px #fff,0 0 12px #00fff6;
    white-space:pre-wrap;
    word-break:break-word;
}

footer{
    grid-area:input;
    background:#1a1a24cc;
    border-top:2px solid #6b00ff;
    box-shadow:0 -20px 60px rgba(255,77,253,.25),
               0 0 40px rgba(0,255,246,.25),
               0 0 120px rgba(107,0,255,.4);
    padding:.75rem;
    display:grid;
    grid-template-columns:1fr auto;
    gap:.5rem;
    align-items:flex-start;
}
#msgInput{
    width:100%;
    height:60px;
    resize:none;
    background:#2a2a38;
    color:#fff;
    border:2px solid #6b00ff;
    border-radius:8px;
    font-size:.8rem;
    line-height:1.3;
    font-family:Consolas,Menlo,monospace;
    padding:.6rem .7rem;
    box-shadow:inset 0 0 12px rgba(0,0,0,.6),
               0 0 20px rgba(107,0,255,.5);
    outline:none;
}
#sendBtn{
    background:radial-gradient(circle at 20% 20%, #00fff6 0%, #003d3d 60%);
    border:0;
    border-radius:10px;
    color:#00fff6;
    text-shadow:0 0 8px #00fff6,0 0 12px #ff4dfd;
    font-size:.8rem;
    font-weight:700;
    line-height:1.2;
    padding:.6rem .8rem;
    cursor:pointer;
    box-shadow:0 12px 30px rgba(0,255,246,.4),
               0 0 20px rgba(255,77,253,.4),
               0 0 60px rgba(107,0,255,.6);
    min-width:120px;
}
#sendBtn:disabled{
    opacity:.4;
    cursor:not-allowed;
}
</style>
</head>
<body>

<header>
    <div class="big">DeepButterfly Realm üíúüëë</div>
    <div class="sub">jeder hat eigene Farben, Sprache, Avatar ‚Äì du bist Owner üëë</div>
</header>

<aside>
    <div class="block">
        <h2>Login</h2>
        <label for="loginUser">Benutzername</label>
        <input id="loginUser" type="text" placeholder="z.B. DarkInfernal" />
        <label for="loginPass">Passwort</label>
        <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <button class="btn" id="loginBtn">Einloggen</button>

        <button class="btn" id="ownerBtn" title="Owner ohne Passwort (nur f√ºr dich üëë)">Owner üëë Login</button>

        <div class="statusLine" id="loginStatus"></div>
    </div>

    <div class="block">
        <h2>Registrieren</h2>
        <label for="regUser">Neuer Name</label>
        <input id="regUser" type="text" placeholder="z.B. MoonPrincess ‚ú®" />
        <label for="regPass">Passwort</label>
        <input id="regPass" type="password" placeholder="Passwort w√§hlen" />

        <label for="regAvatar">Avatar Emoji</label>
        <input id="regAvatar" type="text" value="ü¶ã" />

        <label for="regColor">Name Farbe</label>
        <input id="regColor" type="color" value="#ff4dfd" />

        <label for="regLang">Sprache f√ºr √úbersetzung</label>
        <select id="regLang"></select>

        <label for="regTheme">Dein Style / Theme</label>
        <input id="regTheme" type="text" placeholder="butterfly / fire / rose / neon ..." />

        <button class="btn" id="regBtn">Account erstellen</button>

        <div class="statusLine" id="regStatus"></div>
    </div>

    <div class="block">
        <h2>Dein Profil</h2>
        <small>Du kannst dich selber √§ndern ohne dass Owner zustimmt üíÖ</small>

        <label for="profAvatar">Avatar Emoji</label>
        <input id="profAvatar" type="text" />

        <label for="profColor">Name Farbe</label>
        <input id="profColor" type="color" value="#ffffff"/>

        <label for="profLang">Deine Sprache</label>
        <select id="profLang"></select>

        <label for="profTheme">Theme</label>
        <input id="profTheme" type="text" placeholder="butterfly / fire / etc."/>

        <button class="btn" id="saveProfileBtn">Speichern</button>

        <div class="statusLine" id="profileStatus"></div>
    </div>

    <div class="block">
        <h2>Wer ist online?</h2>
        <div id="onlineList"></div>
    </div>
</aside>

<main>
    <div id="messages"></div>
</main>

<footer>
    <textarea id="msgInput" placeholder="Schreib hier... (dein Text wird s√º√ü korrigiert üíú)" disabled></textarea>
    <button id="sendBtn" disabled>Senden</button>
</footer>

<!-- Socket.io vom Server -->
<script src="/socket.io/socket.io.js"></script>
<script>
const LANGS = [
    {code:"de", name:"Deutsch"},
    {code:"hu", name:"Magyar / Ungarisch"},
    {code:"en", name:"English"},
    {code:"es", name:"Espa√±ol"},
    {code:"fr", name:"Fran√ßais"},
    {code:"it", name:"Italiano"},
    {code:"pt", name:"Portugu√™s"},
    {code:"tr", name:"T√ºrk√ße"},
    {code:"ru", name:"–†—É—Å—Å–∫–∏–π"},
    {code:"ar", name:"ÿßŸÑÿπÿ±ÿ®Ÿäÿ©"},
    {code:"zh", name:"‰∏≠Êñá"},
    {code:"ja", name:"Êó•Êú¨Ë™û"}
];

const SERVERS = [
    "https://translate.astian.org/translate",
    "https://libretranslate.de/translate",
    "https://translate.fedilab.app/translate"
];

const loginUser = document.getElementById("loginUser");
const loginPass = document.getElementById("loginPass");
const loginBtn  = document.getElementById("loginBtn");
const ownerBtn  = document.getElementById("ownerBtn");
const loginStatus = document.getElementById("loginStatus");

const regUser = document.getElementById("regUser");
const regPass = document.getElementById("regPass");
const regAvatar = document.getElementById("regAvatar");
const regColor = document.getElementById("regColor");
const regLang  = document.getElementById("regLang");
const regTheme = document.getElementById("regTheme");
const regBtn   = document.getElementById("regBtn");
const regStatus= document.getElementById("regStatus");

const profAvatar = document.getElementById("profAvatar");
const profColor  = document.getElementById("profColor");
const profLang   = document.getElementById("profLang");
const profTheme  = document.getElementById("profTheme");
const saveProfileBtn = document.getElementById("saveProfileBtn");
const profileStatus  = document.getElementById("profileStatus");

const onlineList = document.getElementById("onlineList");

const messagesEl = document.getElementById("messages");
const msgInput   = document.getElementById("msgInput");
const sendBtn    = document.getElementById("sendBtn");

function fillLangSelect(sel){
    LANGS.forEach(l=>{
        const o=document.createElement("option");
        o.value=l.code;
        o.textContent=l.name;
        sel.appendChild(o);
    });
}
fillLangSelect(regLang);
fillLangSelect(profLang);

let authToken = null;
let myProfile = null;

function setStatus(el, msg, isErr=false){
    el.textContent = msg;
    el.style.color = isErr ? "#ff4dfd" : "#8a8a9f";
}

function fixGermanQuick(t){
    return t
        .replace(/\bich libe dich\b/gi,"ich liebe dich")
        .replace(/\bich libe dich so se(h|r)+\b/gi,"ich liebe dich so sehr")
        .replace(/wi[e] gehts dir/gi,"wie geht es dir")
        .replace(/wo bist du+\b/gi,"wo bist du");
}

async function translateTextSmart(rawText, tgtLang){
    const key = "cache|"+tgtLang+"|"+rawText;
    const cache = sessionStorage.getItem(key);
    if(cache) return cache;

    let translated=null;
    for(const url of SERVERS){
        try{
            const res=await fetch(url,{
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body:JSON.stringify({
                    q: rawText,
                    source:"auto",
                    target:tgtLang,
                    format:"text"
                })
            });
            if(!res.ok) continue;
            const data=await res.json();
            if(data && data.translatedText){
                translated=data.translatedText;
                break;
            }
        }catch(e){}
    }
    if(!translated){
        translated="(konnte nicht √ºbersetzen üò¢)";
    }
    sessionStorage.setItem(key,translated);
    return translated;
}

async function addMessageBubble(msg){
    const isSystem = (msg.from==="System");
    const wrap = document.createElement("div");
    wrap.className="msgBubble"+(isSystem?" system":"");

    const head=document.createElement("div");
    head.className="msgHeader";

    const avSpan=document.createElement("span");
    avSpan.className="avatarEmoji";
    avSpan.textContent=msg.avatar || "üí¨";

    const nameSpan=document.createElement("span");
    nameSpan.className="msgHeaderName";
    nameSpan.textContent=msg.from;
    if(isSystem){
        nameSpan.classList.add("systemName");
        nameSpan.style.color="#888";
        nameSpan.style.textShadow="none";
    } else if(msg.color){
        nameSpan.style.color=msg.color;
        nameSpan.style.textShadow=`0 0 6px ${msg.color},0 0 12px #00fff6`;
    }

    head.appendChild(avSpan);
    head.appendChild(nameSpan);

    if(msg.role==="owner"||msg.role==="admin"){
        const rSpan=document.createElement("span");
        rSpan.className="msgHeaderRole";
        rSpan.textContent="üëë";
        head.appendChild(rSpan);
    }

    wrap.appendChild(head);

    const orig=document.createElement("div");
    orig.className="msgOriginal";
    orig.textContent=msg.text;
    wrap.appendChild(orig);

    if(!isSystem && myProfile){
        const arr=document.createElement("div");
        arr.className="msgArrow";
        arr.textContent="‚Üí √ºbersetzt f√ºr dich:";
        wrap.appendChild(arr);

        const trans=document.createElement("div");
        trans.className="msgTranslation";
        trans.textContent="(√ºbersetze ...)";
        wrap.appendChild(trans);

        const t = await translateTextSmart(msg.text, myProfile.language || "de");
        trans.textContent=t;
    }

    messagesEl.appendChild(wrap);
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

function renderOnlineList(arr){
    onlineList.innerHTML="";
    arr.forEach(u=>{
        const row=document.createElement("div");
        row.className="userRow";

        const line1=document.createElement("div");
        line1.className="nameLine";

        const av=document.createElement("span");
        av.className="avatarEmoji";
        av.textContent=u.avatar||"‚≠ê";

        const nm=document.createElement("span");
        nm.textContent=u.username;
        nm.style.color=u.color||"#fff";
        nm.style.fontWeight="600";
        nm.style.textShadow=`0 0 6px ${u.color||"#fff"},0 0 10px #ff4dfd`;

        line1.appendChild(av);
        line1.appendChild(nm);

        if(u.role==="owner"||u.role==="admin"){
            const cr=document.createElement("span");
            cr.className="roleCrown";
            cr.textContent="üëë";
            line1.appendChild(cr);
        }

        const line2=document.createElement("div");
        line2.className="metaLine";
        line2.textContent="Online ¬∑ Sprache: "+(u.language||"?");

        row.appendChild(line1);
        row.appendChild(line2);

        onlineList.appendChild(row);
    });
}

const socket = io();

socket.on("chatMessage",(msg)=>{
    addMessageBubble(msg);
});

socket.on("userlist",(arr)=>{
    renderOnlineList(arr);
});

function joinChatAfterLogin(){
    if(!authToken) return;
    socket.emit("joinChat", authToken);
}

loginBtn.addEventListener("click", async ()=>{
    setStatus(loginStatus,"Logge ein ...");
    try{
        const res=await fetch("/login",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({
                username: loginUser.value.trim(),
                password: loginPass.value.trim()
            })
        });
        const data=await res.json();
        if(!data.ok){
            setStatus(loginStatus,data.error||"Fehler",true);
            return;
        }
        authToken=data.token;
        myProfile=data.profile;
        setStatus(loginStatus,"Eingeloggt als "+myProfile.username+" ("+myProfile.role+")");
        afterLoginUI();
        joinChatAfterLogin();
    }catch(e){
        setStatus(loginStatus,"Netzwerk-Fehler",true);
    }
});

ownerBtn.addEventListener("click", async ()=>{
    setStatus(loginStatus,"Owner Login ...");
    try{
        const res=await fetch("/login",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({ ownerMode:true })
        });
        const data=await res.json();
        if(!data.ok){
            setStatus(loginStatus,data.error||"Fehler",true);
            return;
        }
        authToken=data.token;
        myProfile=data.profile;
        setStatus(loginStatus,"Owner Modus üëë "+myProfile.username);
        afterLoginUI();
        joinChatAfterLogin();
    }catch(e){
        setStatus(loginStatus,"Netzwerk-Fehler",true);
    }
});

regBtn.addEventListener("click", async ()=>{
    setStatus(regStatus,"Erstelle Account ...");
    try{
        const res=await fetch("/register",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({
                username: regUser.value.trim(),
                password: regPass.value.trim(),
                avatar:   regAvatar.value.trim() || "‚≠ê",
                color:    regColor.value,
                language: regLang.value,
                theme:    regTheme.value.trim() || "default"
            })
        });
        const data=await res.json();
        if(!data.ok){
            setStatus(regStatus,data.error||"Fehler",true);
            return;
        }
        setStatus(regStatus,"Account erstellt!\nRolle: "+data.role+"\nJetzt einloggen üíú");
    }catch(e){
        setStatus(regStatus,"Netzwerk-Fehler",true);
    }
});

saveProfileBtn.addEventListener("click", async ()=>{
    if(!authToken){
        setStatus(profileStatus,"Du bist nicht eingeloggt üôÉ",true);
        return;
    }
    setStatus(profileStatus,"Speichere...");
    try{
        const res=await fetch("/profile",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({
                token: authToken,
                avatar: profAvatar.value.trim(),
                color:  profColor.value,
                language: profLang.value,
                theme: profTheme.value.trim()
            })
        });
        const data=await res.json();
        if(!data.ok){
            setStatus(profileStatus,data.error||"Fehler",true);
            return;
        }
        myProfile=data.profile;
        setStatus(profileStatus,"Gespeichert üíú Dein Style ist jetzt aktiv.");
    }catch(e){
        setStatus(profileStatus,"Netzwerk-Fehler",true);
    }
});

function afterLoginUI(){
    if(!myProfile) return;

    msgInput.disabled=false;
    sendBtn.disabled=false;

    profAvatar.value = myProfile.avatar || "‚≠ê";
    profColor.value  = myProfile.color || "#ffffff";
    profLang.value   = myProfile.language || "de";
    profTheme.value  = myProfile.theme || "default";
    setStatus(profileStatus,"Dein Profil ist geladen üíú");

    setStatus(loginStatus,"Eingeloggt als "+myProfile.username+" ("+myProfile.role+")");
}

sendBtn.addEventListener("click", ()=>{
    if(!authToken){
        setStatus(loginStatus,"Bitte erst einloggen üíú",true);
        return;
    }
    let txt = msgInput.value.trim();
    if(!txt){
        return;
    }
    txt = fixGermanQuick(txt);

    socket.emit("sendMessage", {
        token: authToken,
        text: txt
    });

    msgInput.value="";
    msgInput.focus();
});
</script>
</body>
</html>
