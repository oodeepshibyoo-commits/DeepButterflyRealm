<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>DeepButterfly Realm üíúüëë</title>
<style>
body{
    margin:0;
    background:#0a0a0f;
    color:#fff;
    font-family:Arial,Helvetica,sans-serif;
    display:grid;
    grid-template-columns:260px 1fr;
    grid-template-rows:auto 220px 1fr auto;
    grid-template-areas:
        "side head"
        "side room"
        "side chat"
        "side input";
    height:100vh;
    overflow:hidden;
    position:relative;
}
/* HEADER */
header{
    grid-area:head;
    background:#1a1a24cc;
    border-bottom:2px solid #6b00ff;
    box-shadow:0 20px 60px rgba(255,77,253,.25),
               0 0 40px rgba(0,255,246,.25),
               0 0 120px rgba(107,0,255,.4);
    padding:.75rem 1rem;
    font-size:.8rem;
    line-height:1.4;
    text-align:center;
    z-index:10;
}
header .big{
    color:#ff4dfd;
    font-weight:600;
    text-shadow:0 0 10px #ff4dfd,0 0 20px #00fff6;
}
header .sub{
    color:#00fff6;
    font-size:.7rem;
    text-shadow:0 0 6px #00fff6;
}

/* SIDEBAR */
aside{
    grid-area:side;
    background:#1a1a24dd;
    border-right:2px solid #6b00ff;
    box-shadow:0 0 30px rgba(255,77,253,.3),
               0 0 80px rgba(0,255,246,.2);
    padding:.75rem;
    font-size:.75rem;
    overflow-y:auto;
    z-index:10;
}
h2{
    margin:.5rem 0 .25rem;
    font-size:.75rem;
    font-weight:600;
    color:#ff4dfd;
    text-shadow:0 0 6px #ff4dfd,0 0 10px #00fff6;
}
small{
    color:#8a8a9f;
    font-size:.7rem;
    line-height:1.4;
    display:block;
    margin-bottom:.5rem;
}
.block{
    border:2px solid #6b00ff;
    border-radius:10px;
    background:#2a2a38aa;
    box-shadow:0 0 16px rgba(107,0,255,.4),
               0 0 32px rgba(0,255,246,.2);
    padding:.5rem .75rem;
    margin-bottom:1rem;
    font-size:.7rem;
    line-height:1.4;
}

label{
    display:block;
    font-size:.7rem;
    font-weight:600;
    color:#fff;
    text-shadow:0 0 6px #fff,0 0 10px #00fff6;
    margin-bottom:.25rem;
}
input[type="text"],
input[type="password"],
input[type="color"],
select{
    width:100%;
    background:#2a2a38;
    color:#fff;
    border:2px solid #6b00ff;
    border-radius:8px;
    font-size:.7rem;
    padding:.4rem .5rem;
    margin-bottom:.5rem;
    box-shadow:0 0 12px rgba(107,0,255,.6),
               0 0 24px rgba(0,255,246,.4);
    outline:none;
}
button.btn,
button.smallBtn{
    background:radial-gradient(circle at 20% 20%, #ff4dfd 0%, #6b00ff 60%);
    border:0;
    border-radius:8px;
    color:#000;
    font-size:.75rem;
    font-weight:700;
    line-height:1.2;
    padding:.5rem .6rem;
    cursor:pointer;
    text-shadow:0 0 6px #fff,0 0 12px #00fff6;
    box-shadow:0 12px 30px rgba(255,77,253,.45),
               0 0 20px rgba(0,255,246,.4),
               0 0 60px rgba(107,0,255,.6);
    margin-bottom:.5rem;
}
button.btn:disabled,
button.smallBtn:disabled{
    opacity:.4;
    cursor:not-allowed;
}
.smallBtn{
    display:inline-block;
    margin-right:.25rem;
    margin-bottom:.25rem;
    font-size:.65rem;
    padding:.4rem .5rem;
}
.statusLine{
    color:#8a8a9f;
    font-size:.7rem;
    line-height:1.4;
    min-height:2.8em;
    white-space:pre-wrap;
}

/* ONLINE LISTE */
#onlineList .userRow{
    border:2px solid #6b00ff;
    border-radius:8px;
    background:#2a2a38aa;
    box-shadow:0 0 12px rgba(107,0,255,.4),
               0 0 24px rgba(0,255,246,.2);
    padding:.5rem;
    margin-bottom:.5rem;
    line-height:1.3;
    cursor:pointer;
}
.nameLine{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:.4rem;
    font-weight:600;
}
.avatarEmoji{
    font-size:1rem;
    line-height:1rem;
    animation:bounce 2s ease-in-out infinite;
    text-shadow:0 0 8px #fff,0 0 12px #ff4dfd;
}
@keyframes bounce{
    0%   {transform:translateY(0) rotate(-2deg) scale(1);}
    25%  {transform:translateY(-2px) rotate(2deg) scale(1.05);}
    50%  {transform:translateY(0) rotate(-1deg) scale(1);}
    75%  {transform:translateY(-3px) rotate(3deg) scale(1.07);}
    100% {transform:translateY(0) rotate(-2deg) scale(1);}
}
.roleCrown{
    color:#ffd93b;
    text-shadow:0 0 6px #ffd93b,0 0 12px #ff4dfd;
    font-size:.8rem;
}
.metaLine{
    color:#aaa;
    font-size:.65rem;
}

/* RAUM OBEN */
#roomWrap{
    grid-area:room;
    background:#1a1a24dd;
    border-bottom:2px solid #6b00ff;
    box-shadow:0 0 30px rgba(255,77,253,.3),
               0 0 80px rgba(0,255,246,.2);
    position:relative;
    overflow:hidden;
    padding:.5rem .75rem .75rem;
    font-size:.7rem;
}
#roomTitle{
    color:#ff4dfd;
    font-weight:600;
    font-size:.75rem;
    text-shadow:0 0 10px #ff4dfd,0 0 20px #00fff6;
    margin-bottom:.5rem;
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
}
#roomArea{
    position:relative;
    width:100%;
    height:160px;
    border:2px solid #6b00ff;
    border-radius:10px;
    background:radial-gradient(circle at 20% 20%,rgba(107,0,255,.4)0%,rgba(0,0,0,.2)60%);
    box-shadow:0 0 20px rgba(107,0,255,.6),
               0 0 60px rgba(0,255,246,.2),
               0 0 120px rgba(255,77,253,.2);
    overflow:hidden;
}
.roomAvatar{
    position:absolute;
    cursor:grab;
    user-select:none;
    font-size:1.4rem;
    line-height:1.4rem;
    text-shadow:0 0 8px #fff,0 0 12px #ff4dfd;
    display:flex;
    flex-direction:column;
    align-items:center;
    font-weight:600;
    min-width:2rem;
    text-align:center;
}
.roomName{
    font-size:.6rem;
    margin-top:.25rem;
    text-shadow:0 0 6px #00fff6;
}
.roomCrown{
    color:#ffd93b;
    text-shadow:0 0 6px #ffd93b,0 0 12px #ff4dfd;
    font-size:.6rem;
    margin-left:.25rem;
}

/* CHAT FENSTER */
main{
    grid-area:chat;
    background:#1a1a24dd;
    box-shadow:0 0 30px rgba(255,77,253,.3),
               0 0 80px rgba(0,255,246,.2);
    display:flex;
    flex-direction:column;
    position:relative;
    overflow:hidden;
}
#messages{
    flex:1;
    overflow-y:auto;
    padding:1rem;
    font-family:Consolas,Menlo,monospace;
    font-size:.8rem;
    line-height:1.4;
}
.msgBubble{
    border:2px solid #6b00ff;
    background:#2a2a38;
    box-shadow:0 0 20px rgba(107,0,255,.4),
               0 0 40px rgba(0,255,246,.2);
    border-radius:10px;
    padding:.6rem .7rem;
    margin-bottom:.6rem;
    max-width:85%;
    white-space:pre-wrap;
    word-break:break-word;
}
.msgBubble.system{
    border-color:#444;
    background:#2a2a3844;
    box-shadow:none;
}
.msgHeader{
    font-weight:600;
    font-size:.7rem;
    margin-bottom:.4rem;
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:.4rem;
}
.msgHeaderName{
    text-shadow:0 0 8px #fff,0 0 12px #00fff6;
}
.msgHeaderName.systemName{
    color:#888 !important;
    text-shadow:none;
}
.msgHeaderRole{
    color:#ffd93b;
    text-shadow:0 0 6px #ffd93b,0 0 12px #ff4dfd;
    font-size:.7rem;
}
.msgOriginal{
    color:#bbb;
    margin-bottom:.4rem;
}
.msgInfoLine{
    color:#ff4dfd;
    font-size:.7rem;
    margin-bottom:.3rem;
    text-shadow:0 0 8px #ff4dfd,0 0 12px #00fff6;
    font-weight:500;
}
.msgTranslation{
    color:#fff;
    text-shadow:0 0 6px #fff,0 0 12px #00fff6;
    white-space:pre-wrap;
    word-break:break-word;
}
.msgTime{
    font-size:.6rem;
    font-family:Consolas,Menlo,monospace;
    color:#ff4dfd;
    text-shadow:0 0 8px #ff4dfd,0 0 12px #00fff6;
    margin-top:.4rem;
    text-align:right;
}

/* UNTEN: Nachricht schreiben */
footer{
    grid-area:input;
    background:#1a1a24cc;
    border-top:2px solid #6b00ff;
    box-shadow:0 -20px 60px rgba(255,77,253,.25),
               0 0 40px rgba(0,255,246,.25),
               0 0 120px rgba(107,0,255,.4);
    padding:.75rem;
    display:grid;
    grid-template-columns:1fr auto;
    gap:.5rem;
    align-items:flex-start;
}
#msgInput{
    width:100%;
    height:60px;
    resize:none;
    background:#2a2a38;
    color:#fff;
    border:2px solid #6b00ff;
    border-radius:8px;
    font-size:.8rem;
    line-height:1.3;
    font-family:Consolas,Menlo,monospace;
    padding:.6rem .7rem;
    box-shadow:inset 0 0 12px rgba(0,0,0,.6),
               0 0 20px rgba(107,0,255,.5);
    outline:none;
}
#sendBtn{
    background:radial-gradient(circle at 20% 20%, #00fff6 0%, #003d3d 60%);
    border:0;
    border-radius:10px;
    color:#00fff6;
    text-shadow:0 0 8px #00fff6,0 0 12px #ff4dfd;
    font-size:.8rem;
    font-weight:700;
    line-height:1.2;
    padding:.6rem .8rem;
    cursor:pointer;
    box-shadow:0 12px 30px rgba(0,255,246,.4),
               0 0 20px rgba(255,77,253,.4),
               0 0 60px rgba(107,0,255,.6);
    min-width:120px;
}
#sendBtn:disabled{
    opacity:.4;
    cursor:not-allowed;
}

/* Hilfe-Box */
#helpBox{
    border:1px solid #6b00ff;
    border-radius:8px;
    background:#1a1a24;
    box-shadow:0 0 16px rgba(107,0,255,.4),
               0 0 32px rgba(0,255,246,.2);
    padding:.5rem .6rem;
    font-size:.7rem;
    line-height:1.4;
    color:#fff;
    white-space:pre-wrap;
}
#helpBoxTitle{
    font-weight:600;
    color:#ff4dfd;
    text-shadow:0 0 8px #ff4dfd,0 0 12px #00fff6;
    margin-bottom:.4rem;
    font-size:.7rem;
}
</style>
</head>
<body>

<header>
    <div class="big">DeepButterfly Realm üíúüëë</div>
    <div class="sub">Owner ¬∑ Kick/Ban ¬∑ Co-Owner ¬∑ Avatare ¬∑ Sitzen ¬∑ Spiele kommen ü¶ã</div>
</header>

<aside>
    <!-- LOGIN -->
    <div class="block">
        <h2>Login</h2>
        <label for="loginUser">Benutzername</label>
        <input id="loginUser" type="text" placeholder="z.B. DeepButterflyMusic" />
        <label for="loginPass">Passwort</label>
        <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <button class="btn" id="loginBtn">Einloggen</button>
        <div class="statusLine" id="loginStatus"></div>
    </div>

    <!-- REGISTRIEREN -->
    <div class="block">
        <h2>Registrieren</h2>

        <label for="regUser">Neuer Name</label>
        <input id="regUser" type="text" placeholder="z.B. DarkInfernal" />
        <label for="regPass">Passwort</label>
        <input id="regPass" type="password" placeholder="Passwort w√§hlen" />

        <label for="regAvatar">Avatar Emoji / Symbol</label>
        <input id="regAvatar" type="text" value="ü¶ã" />

        <label for="regColor">Name Farbe</label>
        <input id="regColor" type="color" value="#ff4dfd" />

        <label for="regLang">Sprache f√ºr √úbersetzung</label>
        <select id="regLang"></select>

        <label for="regTheme">Dein Style / Theme / Schrift</label>
        <input id="regTheme" type="text" placeholder="butterfly / fire / rose / neon ..." />

        <button class="btn" id="regBtn">Account erstellen</button>

        <div class="statusLine" id="regStatus"></div>

        <div class="statusLine" style="border-top:1px solid #6b00ff; padding-top:.5rem;">
            Der ALLERERSTE Account wird automatisch üëë Owner.
            Owner/CoOwner/Admin k√∂nnen: kicken, bannen, Co-Owner vergeben.
        </div>
    </div>

    <!-- PROFIL -->
    <div class="block">
        <h2>Dein Profil</h2>
        <small>Avatar / Farbe / Sprache / Theme kannst du √§ndern üíÖ</small>

        <label for="profAvatar">Avatar Emoji</label>
        <input id="profAvatar" type="text" />

        <label for="profColor">Name Farbe</label>
        <input id="profColor" type="color" value="#ffffff"/>

        <label for="profLang">Deine Sprache</label>
        <select id="profLang"></select>

        <label for="profTheme">Theme / Schrift</label>
        <input id="profTheme" type="text" placeholder="butterfly / fire / etc."/>

        <button class="btn" id="saveProfileBtn">Speichern</button>

        <div class="statusLine" id="profileStatus"></div>

        <!-- ADMIN PANEL -->
        <div id="adminPanel" style="display:none;border-top:1px solid #6b00ff;margin-top:.5rem;padding-top:.5rem;">
            <div style="font-weight:600;color:#ff4dfd;text-shadow:0 0 8px #ff4dfd,0 0 12px #00fff6;margin-bottom:.5rem;">
                Ziel: <span id="adminTargetUserTxt">Niemand</span>
            </div>

            <button class="smallBtn" id="makeOwnerBtn">üëë Owner geben</button>
            <button class="smallBtn" id="makeCoOwnerBtn">üëë Co-Owner geben</button>
            <button class="smallBtn" id="kickBtn">üö´ Kicken</button>
            <button class="smallBtn" id="banBtn">‚ùå Bannen</button>
            <button class="smallBtn" id="unbanBtn">‚ôªÔ∏è Unban</button>

            <div class="statusLine" id="adminStatus"></div>
        </div>
    </div>

    <!-- ONLINE USERS -->
    <div class="block">
        <h2>Wer ist online?</h2>
        <small>Tippe einen Namen (wenn du Owner/CoOwner/Admin bist) f√ºr Aktionen</small>
        <div id="onlineList"></div>
    </div>
</aside>

<!-- RAUM OBEN -->
<div id="roomWrap">
    <div id="roomTitle">
        <span>ü¶ã Butterfly Room ¬∑ Zieh dich wohin du willst ¬∑ Sit Pl√§tze üí∫ ¬∑ AFK Ecke</span>
        <span style="color:#8a8a9f;font-size:.65rem;line-height:1.2;">
            (Avatar ziehen = bewegen, sp√§ter Tanzfl√§che & Spiele ‚ú®)
        </span>
    </div>
    <div id="roomArea"></div>
</div>

<!-- CHAT -->
<main>
    <div id="messages"></div>
</main>

<!-- NACHRICHT SENDEN -->
<footer>
    <textarea id="msgInput" placeholder="Schreib hier... (Enter = senden, Shift+Enter = neue Zeile)" disabled></textarea>
    <button id="sendBtn" disabled>Senden</button>
</footer>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
// ===== Sprachliste =====
const LANGS = [
    {code:"de", name:"Deutsch"},
    {code:"hu", name:"Magyar / Ungarisch"},
    {code:"en", name:"English"},
    {code:"es", name:"Espa√±ol"},
    {code:"fr", name:"Fran√ßais"},
    {code:"it", name:"Italiano"},
    {code:"pt", name:"Portugu√™s"},
    {code:"tr", name:"T√ºrk√ße"},
    {code:"ru", name:"–†—É—Å—Å–∫–∏–π"},
    {code:"ar", name:"ÿßŸÑÿπÿ±ÿ®Ÿäÿ©"},
    {code:"zh", name:"‰∏≠Êñá"},
    {code:"ja", name:"Êó•Êú¨Ë™û"}
];

// ===== DOM Elemente =====
const loginUser = document.getElementById("loginUser");
const loginPass = document.getElementById("loginPass");
const loginBtn  = document.getElementById("loginBtn");
const loginStatus = document.getElementById("loginStatus");

const regUser = document.getElementById("regUser");
const regPass = document.getElementById("regPass");
const regAvatar = document.getElementById("regAvatar");
const regColor  = document.getElementById("regColor");
const regLang   = document.getElementById("regLang");
const regTheme  = document.getElementById("regTheme");
const regBtn    = document.getElementById("regBtn");
const regStatus = document.getElementById("regStatus");

const profAvatar = document.getElementById("profAvatar");
const profColor  = document.getElementById("profColor");
const profLang   = document.getElementById("profLang");
const profTheme  = document.getElementById("profTheme");
const saveProfileBtn = document.getElementById("saveProfileBtn");
const profileStatus  = document.getElementById("profileStatus");

const adminPanel     = document.getElementById("adminPanel");
const adminStatus    = document.getElementById("adminStatus");
const adminTargetTxt = document.getElementById("adminTargetUserTxt");
const makeOwnerBtn   = document.getElementById("makeOwnerBtn");
const makeCoOwnerBtn = document.getElementById("makeCoOwnerBtn");
const kickBtn        = document.getElementById("kickBtn");
const banBtn         = document.getElementById("banBtn");
const unbanBtn       = document.getElementById("unbanBtn");

const onlineList = document.getElementById("onlineList");
const roomArea   = document.getElementById("roomArea");
const messagesEl = document.getElementById("messages");
const msgInput   = document.getElementById("msgInput");
const sendBtn    = document.getElementById("sendBtn");

// ===== STATE =====
let authToken = null;
let myProfile = null;
let dragging  = null; // { username, el, offsetX, offsetY }
let currentRoom = {}; // username -> {x,y,avatar,color,role}
let adminTargetUser = null;

// ===== helpers =====
function fillLangSelect(sel){
    LANGS.forEach(l=>{
        const o=document.createElement("option");
        o.value=l.code;
        o.textContent=l.name;
        sel.appendChild(o);
    });
}
fillLangSelect(regLang);
fillLangSelect(profLang);

function setStatus(el, msg, isErr=false){
    el.textContent = msg;
    el.style.color = isErr ? "#ff4dfd" : "#8a8a9f";
}

function fixGermanQuick(t){
    return t
        .replace(/\bich libe dich\b/gi,"ich liebe dich")
        .replace(/wi[e] gehts dir/gi,"wie geht es dir")
        .replace(/wo bist du+\b/gi,"wo bist du");
}

// ===== Chat Nachricht anzeigen =====
function addMessageBubble(msg){
    const isSystem = (msg.from==="System");

    const wrap = document.createElement("div");
    wrap.className="msgBubble"+(isSystem?" system":"");

    const head=document.createElement("div");
    head.className="msgHeader";

    const avSpan=document.createElement("span");
    avSpan.className="avatarEmoji";
    avSpan.textContent=msg.avatar || "üí¨";

    const nameSpan=document.createElement("span");
    nameSpan.className="msgHeaderName";
    nameSpan.textContent=msg.from;
    if(isSystem){
        nameSpan.classList.add("systemName");
        nameSpan.style.color="#888";
        nameSpan.style.textShadow="none";
    } else if(msg.color){
        nameSpan.style.color=msg.color;
        nameSpan.style.textShadow=`0 0 6px ${msg.color},0 0 12px #00fff6`;
    }

    head.appendChild(avSpan);
    head.appendChild(nameSpan);

    if(msg.role==="owner"||msg.role==="coOwner"||msg.role==="admin"){
        const rSpan=document.createElement("span");
        rSpan.className="msgHeaderRole";
        rSpan.textContent="üëë";
        head.appendChild(rSpan);
    }

    wrap.appendChild(head);

    const orig=document.createElement("div");
    orig.className="msgOriginal";
    orig.textContent=msg.text;
    wrap.appendChild(orig);

    // Info + Uhrzeit
    const info=document.createElement("div");
    info.className="msgInfoLine";
    const t = new Date(msg.timestamp || Date.now());
    info.textContent = "gesendet ‚Ä¢ "+t.toLocaleTimeString();
    wrap.appendChild(info);

    messagesEl.appendChild(wrap);
    messagesEl.scrollTop=messagesEl.scrollHeight;
}

// ===== Online Liste rendern =====
function renderOnlineList(arr){
    onlineList.innerHTML="";
    arr.forEach(u=>{
        const row=document.createElement("div");
        row.className="userRow";

        const line1=document.createElement("div");
        line1.className="nameLine";

        const av=document.createElement("span");
        av.className="avatarEmoji";
        av.textContent=u.avatar || "ü¶ã";

        const nm=document.createElement("span");
        nm.textContent=u.username;
        nm.style.color=u.color||"#fff";
        nm.style.fontWeight="600";
        nm.style.textShadow=`0 0 6px ${u.color||"#fff"},0 0 10px #ff4dfd`;

        line1.appendChild(av);
        line1.appendChild(nm);

        if(u.role==="owner"||u.role==="coOwner"||u.role==="admin"){
            const cr=document.createElement("span");
            cr.className="roleCrown";
            cr.textContent="üëë";
            line1.appendChild(cr);
        }

        const line2=document.createElement("div");
        line2.className="metaLine";
        line2.textContent="Sprache: "+(u.language||"?");

        row.appendChild(line1);
        row.appendChild(line2);

        row.addEventListener("click", ()=>{
            if(!myProfile) return;
            const iAmMod = (myProfile.role==="owner"||myProfile.role==="coOwner"||myProfile.role==="admin");
            if(!iAmMod) return;
            if(myProfile.username===u.username) return;

            adminTargetUser = u.username;
            adminTargetTxt.textContent = u.username;
            adminPanel.style.display="block";
        });

        onlineList.appendChild(row);
    });
}

// ===== Raum rendern =====
function renderRoom(){
    roomArea.innerHTML="";
    for(const username in currentRoom){
        const info=currentRoom[username];
        const box=document.createElement("div");
        box.className="roomAvatar";
        box.style.left=(info.x||20)+"px";
        box.style.top =(info.y||20)+"px";

        const face=document.createElement("div");
        face.textContent=info.avatar || "ü¶ã";
        face.style.textShadow=`0 0 8px ${info.color||"#fff"},0 0 12px #ff4dfd`;

        const nameLine=document.createElement("div");
        nameLine.className="roomName";
        nameLine.style.color=info.color||"#fff";
        nameLine.style.textShadow=`0 0 6px ${info.color||"#fff"},0 0 10px #00fff6`;
        nameLine.textContent=username;
        if(info.role==="owner"||info.role==="coOwner"||info.role==="admin"){
            const crown=document.createElement("span");
            crown.className="roomCrown";
            crown.textContent="üëë";
            nameLine.appendChild(crown);
        }

        box.appendChild(face);
        box.appendChild(nameLine);

        if(myProfile && username===myProfile.username){
            box.addEventListener("mousedown",(ev)=>{
                dragging={
                    username,
                    el:box,
                    offsetX:ev.offsetX,
                    offsetY:ev.offsetY
                };
            });
            box.addEventListener("touchstart",(ev)=>{
                const t=ev.touches[0];
                const rect=box.getBoundingClientRect();
                dragging={
                    username,
                    el:box,
                    offsetX:t.clientX-rect.left,
                    offsetY:t.clientY-rect.top
                };
            },{passive:false});
        }

        roomArea.appendChild(box);
    }
}

function onMovePointer(clientX,clientY){
    if(!dragging || !myProfile) return;
    if(dragging.username!==myProfile.username) return;

    const bounds=roomArea.getBoundingClientRect();
    let newX=clientX-bounds.left-dragging.offsetX;
    let newY=clientY-bounds.top -dragging.offsetY;

    if(newX<0)newX=0;
    if(newY<0)newY=0;
    if(newX>bounds.width-40)newX=bounds.width-40;
    if(newY>bounds.height-40)newY=bounds.height-40;

    dragging.el.style.left=newX+"px";
    dragging.el.style.top =newY+"px";

    socket.emit("moveAvatar",{
        token:authToken,
        x:newX,
        y:newY
    });
}

window.addEventListener("mousemove",(ev)=>onMovePointer(ev.clientX,ev.clientY));
window.addEventListener("touchmove",(ev)=>{
    if(ev.touches&&ev.touches[0]){
        onMovePointer(ev.touches[0].clientX,ev.touches[0].clientY);
    }
},{passive:false});
window.addEventListener("mouseup",()=>{dragging=null;});
window.addEventListener("touchend",()=>{dragging=null;});

// ===== SOCKET =====
const socket = io();

// Chat
socket.on("chatMessage",(msg)=>{
    addMessageBubble(msg);
});

// userlist
socket.on("userlist",(arr)=>{
    renderOnlineList(arr);
});

// Raum Update
socket.on("roomUpdate",(state)=>{
    currentRoom = state || {};
    renderRoom();
});

// Jemand wurde gekickt/gebannt
socket.on("forceLogout",(data)=>{
    alert(data?.reason || "Du wurdest getrennt.");
    authToken=null;
    myProfile=null;
    msgInput.disabled=true;
    sendBtn.disabled=true;
    setStatus(loginStatus,"Du bist ausgeloggt / entfernt.",true);
});

// ===== LOGIN =====
function joinChatAfterLogin(){
    if(!authToken) return;
    socket.emit("joinChat", authToken);
}

loginBtn.addEventListener("click", async ()=>{
    setStatus(loginStatus,"Logge ein ...");
    try{
        const res=await fetch("/login",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                username: loginUser.value.trim(),
                password: loginPass.value.trim()
            })
        });
        const data=await res.json();
        if(!data.ok){
            setStatus(loginStatus,data.error||"Fehler",true);
            return;
        }
        authToken=data.token;
        myProfile=data.profile;
        setStatus(loginStatus,"Eingeloggt als "+myProfile.username+" ("+myProfile.role+")");
        afterLoginUI();
        joinChatAfterLogin();
    }catch(e){
        setStatus(loginStatus,"Netzwerk-Fehler",true);
    }
});

// ===== REGISTER =====
regBtn.addEventListener("click", async ()=>{
    setStatus(regStatus,"Erstelle Account ...");
    try{
        const res=await fetch("/register",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                username: regUser.value.trim(),
                password: regPass.value.trim(),
                avatar:   regAvatar.value.trim()||"ü¶ã",
                color:    regColor.value,
                language: regLang.value,
                theme:    regTheme.value.trim()||"default"
            })
        });
        const data=await res.json();
        if(!data.ok){
            setStatus(regStatus,data.error||"Fehler",true);
            return;
        }
        setStatus(regStatus,"Account erstellt!\nRolle: "+data.role+"\nJetzt einloggen üíú");
    }catch(e){
        setStatus(regStatus,"Netzwerk-Fehler",true);
    }
});

// ===== PROFIL SPEICHERN =====
saveProfileBtn.addEventListener("click", async ()=>{
    if(!authToken){
        setStatus(profileStatus,"Du bist nicht eingeloggt üôÉ",true);
        return;
    }
    setStatus(profileStatus,"Speichere...");
    try{
        const res=await fetch("/profile",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                token: authToken,
                avatar: profAvatar.value.trim(),
                color:  profColor.value,
                language: profLang.value,
                theme: profTheme.value.trim()
            })
        });
        const data=await res.json();
        if(!data.ok){
            setStatus(profileStatus,data.error||"Fehler",true);
            return;
        }
        myProfile=data.profile;
        setStatus(profileStatus,"Gespeichert üíú");
    }catch(e){
        setStatus(profileStatus,"Netzwerk-Fehler",true);
    }
});

function afterLoginUI(){
    if(!myProfile) return;

    msgInput.disabled=false;
    sendBtn.disabled=false;

    profAvatar.value = myProfile.avatar || "ü¶ã";
    profColor.value  = myProfile.color || "#ffffff";
    profLang.value   = myProfile.language || "de";
    profTheme.value  = myProfile.theme || "default";

    setStatus(profileStatus,"Dein Profil ist geladen üíú");

    if(myProfile.role==="owner"||myProfile.role==="coOwner"||myProfile.role==="admin"){
        adminPanel.style.display="block";
    } else {
        adminPanel.style.display="none";
    }
}

// ===== CHAT SENDEN =====
msgInput.addEventListener("keydown",(ev)=>{
    if (ev.key==="Enter" && !ev.shiftKey){
        ev.preventDefault();
        if(!sendBtn.disabled){
            sendBtn.click();
        }
    }
});

sendBtn.addEventListener("click", ()=>{
    if(!authToken){
        setStatus(loginStatus,"Bitte erst einloggen üíú",true);
        return;
    }
    let txt=msgInput.value.trim();
    if(!txt)return;
    txt=fixGermanQuick(txt);

    socket.emit("sendMessage",{
        token:authToken,
        text:txt
    });

    msgInput.value="";
    msgInput.focus();
});

// ===== ADMIN BUTTONS =====
makeOwnerBtn.addEventListener("click",()=>{
    if(!authToken||!myProfile)return;
    if(!adminTargetUser)return;
    socket.emit("promoteAdmin",{
        token:authToken,
        targetUser:adminTargetUser
    });
});
kickBtn.addEventListener("click",()=>{
    if(!authToken||!myProfile)return;
    if(!adminTargetUser)return;
    socket.emit("kickUser",{
        token:authToken,
        targetUser:adminTargetUser
    });
});
banBtn.addEventListener("click",()=>{
    if(!authToken||!myProfile)return;
    if(!adminTargetUser)return;
    socket.emit("banUser",{
        token:authToken,
        targetUser:adminTargetUser
    });
});
// unban nur sp√§ter serverseitig extra route n√∂tig

</script>
</body>
</html>